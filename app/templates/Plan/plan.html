{% extends 'admin_base.html' %}

{% block title %}Quáº£n lÃ½ GÃ³i CÆ°á»›c{% endblock %}

{% block content %}
<style>
    .container { width: 80%; margin: 40px auto; }
    .search-filter { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .search-filter input, .search-filter select { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem; margin-right: 10px; }
    .search-filter button { padding: 10px; border-radius: 5px; border: none; background-color: #3498db; color: white; cursor: pointer; }
    .search-filter button:hover { opacity: 0.9; }
    .search-filter .btn-reset { background-color: #e74c3c; }
    table { width: 100%; border-collapse: collapse; background-color: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
    th, td { padding: 14px; text-align: center; border: 1px solid #ddd; }
    th { background-color: #007bff; color: white; }
    tr:nth-child(even) { background-color: #f8f9fa; }
    tr:hover { background-color: #f1f1f1; }
    .status-active { color: green; font-weight: bold; }
    .status-locked { color: red; font-weight: bold; }
    .btn { padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; color: white; }
    .btn-lock { background-color: #e74c3c; }
    .btn-update { background-color: #3498db; margin-right: 5px; }
    .btn-add { background-color: #2ecc71; margin-bottom: 20px; padding: 10px 20px; font-size: 1rem; }
    .btn:hover:not(:disabled) { opacity: 0.9; }
    .btn:disabled { background-color: #a0a0a0; cursor: not-allowed; opacity: 0.6; }
    .flashes { list-style: none; padding: 10px; margin-bottom: 20px; border-radius: 5px; }
    .flashes li.success { background-color: #d4edda; color: #155724; }
    .flashes li.error { background-color: #f8d7da; color: #721c24; }
    .pagination { display: flex; justify-content: center; align-items: center; margin-top: 20px; }
    .pagination button { padding: 8px 12px; margin: 0 5px; border: none; border-radius: 5px; background-color: #3498db; color: white; cursor: pointer; }
    .pagination button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
    .pagination span { font-size: 1rem; margin: 0 10px; }
</style>

<div class="container">
    <h1 class="text-4xl font-bold text-gray-800 mb-6 flex items-center">
        <span class="mr-3">ğŸ“‹</span> Danh sÃ¡ch GÃ³i CÆ°á»›c
    </h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul class="flashes">
        {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}

    <button class="btn btn-add" onclick="window.location.href='/plans/create'">â• ThÃªm gÃ³i cÆ°á»›c</button>

    <div class="search-filter">
        <input type="text" id="codeInput" placeholder="MÃ£ Code">
        <input type="number" id="priceInput" placeholder="GiÃ¡ (VND)" step="0.01" min="0">
        <select id="statusInput">
            <option value="">Táº¥t cáº£ tráº¡ng thÃ¡i</option>
            <option value="1">Äang hoáº¡t Ä‘á»™ng</option>
            <option value="0">ÄÃ£ khÃ³a</option>
        </select>
        <button onclick="searchPlans()">ğŸ” TÃ¬m kiáº¿m</button>
        <button class="btn-reset" onclick="resetSearch()">ğŸ”„ Äáº·t láº¡i</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Thá»© tá»±</th>
                <th>MÃ£ Code</th>
                <th>MÃ´ táº£</th>
                <th>GiÃ¡</th>
                <th>CÃº phÃ¡p Ä‘Äƒng kÃ½</th>
                <th>CÃº phÃ¡p gia háº¡n</th>
                <th>CÃº phÃ¡p há»§y</th>
                <th>Tráº¡ng thÃ¡i</th>
                <th>Thao tÃ¡c</th>
            </tr>
        </thead>
        <tbody id="planTableBody">
            {% for plan in plans %}
            <tr class="plan-row" style="display: none;">
                <td>{{ loop.index }}</td>
                <td>{{ plan.code }}</td>
                <td>{{ plan.description or '' }}</td>
                <td class="text-end">{{ "{:,.0f}".format(plan.price) }} Ä‘</td>
                <td>{{ plan.registration_syntax or '' }}</td>
                <td>{{ plan.renewal_syntax or '' }}</td>
                <td>{{ plan.cancel_syntax or '' }}</td>
                <td class="{{ 'status-active' if plan.is_active else 'status-locked' }}">
                    {{ 'Äang hoáº¡t Ä‘á»™ng' if plan.is_active else 'ÄÃ£ khÃ³a' }}
                </td>
                <td>
                    <button class="btn btn-update" onclick="location.href='/plans/update/{{ plan.id }}'" {% if not plan.is_active %}disabled{% endif %}>ğŸ›  Cáº­p nháº­t</button>
                    {% if plan.is_active %}
                    <button class="btn btn-lock" data-plan-id="{{ plan.id }}" onclick="lockPlan(this)">ğŸ”’ KhÃ³a</button>
                    {% else %}
                    <button class="btn btn-lock" disabled>ğŸ”’ ÄÃ£ khÃ³a</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="pagination">
        <button onclick="prevPage()" id="prevPage">â†</button>
        <span id="pageInfo">Trang 1</span>
        <button onclick="nextPage()" id="nextPage">â†’</button>
    </div>
</div>

<script>
    const rowsPerPage = 8;
    let currentPage = 1;
    let allRows = document.querySelectorAll(".plan-row");

    function updatePagination() {
        allRows = document.querySelectorAll(".plan-row");
        const totalRows = allRows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);

        allRows.forEach((row, index) => {
            row.style.display = (index >= (currentPage - 1) * rowsPerPage && index < currentPage * rowsPerPage) ? "" : "none";
        });

        document.getElementById("pageInfo").textContent = `Trang ${currentPage}`;
        document.getElementById("prevPage").disabled = currentPage === 1;
        document.getElementById("nextPage").disabled = currentPage === totalPages || totalRows === 0;
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            updatePagination();
        }
    }

    function nextPage() {
        const totalRows = allRows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            updatePagination();
        }
    }

    function searchPlans() {
        const code = document.getElementById("codeInput").value;
        const price = document.getElementById("priceInput").value;
        const status = document.getElementById("statusInput").value;

        fetch('/plans/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ code, price, is_active: status })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const tbody = document.getElementById("planTableBody");
            tbody.innerHTML = '';
            data.forEach((plan, index) => {
                const row = `
                    <tr class="plan-row">
                        <td>${index + 1}</td>
                        <td>${plan.code}</td>
                        <td>${plan.description || ''}</td>
                        <td class="text-end">${new Intl.NumberFormat('vi-VN').format(plan.price)} Ä‘</td>
                        <td>${plan.registration_syntax || ''}</td>
                        <td>${plan.renewal_syntax || ''}</td>
                        <td>${plan.cancel_syntax || ''}</td>
                        <td class="${plan.is_active ? 'status-active' : 'status-locked'}">
                            ${plan.is_active ? 'Äang hoáº¡t Ä‘á»™ng' : 'ÄÃ£ khÃ³a'}
                        </td>
                        <td>
                            <button class="btn btn-update" onclick="location.href='/plans/update/${plan.id}'" ${plan.is_active ? '' : 'disabled'}>ğŸ›  Cáº­p nháº­t</button>
                            ${plan.is_active ? 
                                `<button class="btn btn-lock" data-plan-id="${plan.id}" onclick="lockPlan(this)">ğŸ”’ KhÃ³a</button>` :
                                `<button class="btn btn-lock" disabled>ğŸ”’ ÄÃ£ khÃ³a</button>`}
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
            currentPage = 1;
            updatePagination();
        })
        .catch(error => {
            console.error("Lá»—i khi tÃ¬m kiáº¿m:", error);
            alert("Lá»—i khi tÃ¬m kiáº¿m: " + error.message);
        });
    }

    function resetSearch() {
        // XÃ³a giÃ¡ trá»‹ cÃ¡c trÆ°á»ng tÃ¬m kiáº¿m
        document.getElementById("codeInput").value = '';
        document.getElementById("priceInput").value = '';
        document.getElementById("statusInput").value = '';

        // Gá»i API Ä‘á»ƒ láº¥y danh sÃ¡ch gÃ³i cÆ°á»›c ban Ä‘áº§u
        fetch('/plans/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const tbody = document.getElementById("planTableBody");
            tbody.innerHTML = '';
            data.forEach((plan, index) => {
                const row = `
                    <tr class="plan-row">
                        <td>${index + 1}</td>
                        <td>${plan.code}</td>
                        <td>${plan.description || ''}</td>
                        <td class="text-end">${new Intl.NumberFormat('vi-VN').format(plan.price)} Ä‘</td>
                        <td>${plan.registration_syntax || ''}</td>
                        <td>${plan.renewal_syntax || ''}</td>
                        <td>${plan.cancel_syntax || ''}</td>
                        <td class="${plan.is_active ? 'status-active' : 'status-locked'}">
                            ${plan.is_active ? 'Äang hoáº¡t Ä‘á»™ng' : 'ÄÃ£ khÃ³a'}
                        </td>
                        <td>
                            <button class="btn btn-update" onclick="location.href='/plans/update/${plan.id}'" ${plan.is_active ? '' : 'disabled'}>ğŸ›  Cáº­p nháº­t</button>
                            ${plan.is_active ? 
                                `<button class="btn btn-lock" data-plan-id="${plan.id}" onclick="lockPlan(this)">ğŸ”’ KhÃ³a</button>` :
                                `<button class="btn btn-lock" disabled>ğŸ”’ ÄÃ£ khÃ³a</button>`}
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
            currentPage = 1;
            updatePagination();
        })
        .catch(error => {
            console.error("Lá»—i khi Ä‘áº·t láº¡i:", error);
            alert("Lá»—i khi Ä‘áº·t láº¡i danh sÃ¡ch: " + error.message);
        });
    }

    function lockPlan(button) {
        const planId = button.getAttribute("data-plan-id");
        if (confirm("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n khÃ³a gÃ³i cÆ°á»›c nÃ y khÃ´ng?")) {
            fetch(`/plans/lock/${planId}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert("CÃ³ lá»—i xáº£y ra khi khÃ³a gÃ³i cÆ°á»›c.");
                }
            })
            .catch(error => {
                alert("Lá»—i khi khÃ³a gÃ³i cÆ°á»›c: " + error);
            });
        }
    }

    // Khá»Ÿi táº¡o phÃ¢n trang khi táº£i trang
    updatePagination();
</script>
{% endblock %}