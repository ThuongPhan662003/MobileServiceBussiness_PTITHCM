{% extends 'admin_base.html' %}

{% block title %}C·∫≠p nh·∫≠t G√≥i C∆∞·ªõc{% endblock %}

{% block content %}
<style>
    .container { width: 60%; margin: 40px auto; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
    .form-group input[type="checkbox"] { width: auto; }
    .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; color: white; }
    .btn-submit { background-color: #2ecc71; }
    .btn-cancel { background-color: #e74c3c; margin-left: 10px; }
    .btn:hover { opacity: 0.9; }
    .flashes { list-style: none; padding: 10px; margin-bottom: 20px; border-radius: 5px; }
    .flashes li.error { background-color: #f8d7da; color: #721c24; }
    .flashes li.success { background-color: #d4edda; color: #155724; }
    .required::after { content: " *"; color: red; }
    .error { border-color: #e74c3c; }
    .error-message { color: #e74c3c; font-size: 0.9em; margin-top: 5px; }
</style>

<div class="container">
    <h1 class="text-4xl font-bold text-gray-800 mb-6 flex items-center">
        <span class="mr-3">üõ†</span> C·∫≠p nh·∫≠t G√≥i C∆∞·ªõc
    </h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul class="flashes">
        {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('plan.update_plan', plan_id=plan_id) }}" id="update-plan-form">
        <div class="form-group">
            <label for="code" class="required">M√£ Code</label>
            <input type="text" id="code" name="code" value="{{ plan['code'] }}" maxlength="50" required>
        </div>
        <div class="form-group">
            <label for="description">M√¥ t·∫£</label>
            <textarea id="description" name="description" rows="4">{{ plan['description'] or '' }}</textarea>
        </div>
        <div class="form-group">
            <label for="price" class="required">Gi√° (VND)</label>
            <input type="number" id="price" name="price" step="0.01" value="{{ plan['price'] }}" min="0.01" required placeholder="VND">
        </div>
        <div class="form-group">
            <label for="registration_syntax">C√∫ ph√°p ƒëƒÉng k√Ω</label>
            <input type="text" id="registration_syntax" name="registration_syntax" value="{{ plan['registration_syntax'] or '' }}" maxlength="255">
        </div>
        <div class="form-group">
            <label for="renewal_syntax">C√∫ ph√°p gia h·∫°n</label>
            <input type="text" id="renewal_syntax" name="renewal_syntax" value="{{ plan['renewal_syntax'] or '' }}" maxlength="255">
        </div>
        <div class="form-group">
            <label for="cancel_syntax">C√∫ ph√°p h·ªßy</label>
            <input type="text" id="cancel_syntax" name="cancel_syntax" value="{{ plan['cancel_syntax'] or '' }}" maxlength="255">
        </div>
        <div class="form-group">
            <label for="free_data">D·ªØ li·ªáu mi·ªÖn ph√≠ (MB)</label>
            <input type="number" id="free_data" name="free_data" value="{{ plan['free_data'] or '0' }}" min="0" placeholder="MB">
        </div>
        <div class="form-group">
            <label for="free_on_network_a_call">Th·ªùi l∆∞·ª£ng mi·ªÖn ph√≠ cho m·ªói cu·ªôc g·ªçi n·ªôi m·∫°ng (Ph√∫t)</label>
            <input type="number" id="free_on_network_a_call" name="free_on_network_a_call" value="{{ plan['free_on_network_a_call'] or '0' }}" min="0" placeholder="Ph√∫t">
        </div>
        <div class="form-group">
            <label for="free_on_network_call">Th·ªùi l∆∞·ª£ng g·ªçi n·ªôi m·∫°ng mi·ªÖn ph√≠ (Ph√∫t)</label>
            <input type="number" id="free_on_network_call" name="free_on_network_call" value="{{ plan['free_on_network_call'] or '0' }}" min="0" placeholder="Ph√∫t">
        </div>
        <div class="form-group">
            <label for="free_on_network_SMS">S·ªë tin nh·∫Øn SMS n·ªôi m·∫°ng mi·ªÖn ph√≠</label>
            <input type="number" id="free_on_network_SMS" name="free_on_network_SMS" value="{{ plan['free_on_network_SMS'] or '0' }}" min="0">
        </div>
        <div class="form-group">
            <label for="free_off_network_a_call">Th·ªùi l∆∞·ª£ng mi·ªÖn ph√≠ cho m·ªói cu·ªôc g·ªçi ngo·∫°i m·∫°ng (Ph√∫t)</label>
            <input type="number" id="free_off_network_a_call" name="free_off_network_a_call" value="{{ plan['free_off_network_a_call'] or '0' }}" min="0" placeholder="Ph√∫t">
        </div>
        <div class="form-group">
            <label for="free_off_network_call">Th·ªùi l∆∞·ª£ng g·ªçi ngo·∫°i m·∫°ng mi·ªÖn ph√≠ (Ph√∫t)</label>
            <input type="number" id="free_off_network_call" name="free_off_network_call" value="{{ plan['free_off_network_call'] or '0' }}" min="0" placeholder="Ph√∫t">
        </div>
        <div class="form-group">
            <label for="free_off_network_SMS">S·ªë tin nh·∫Øn SMS ngo·∫°i m·∫°ng mi·ªÖn ph√≠</label>
            <input type="number" id="free_off_network_SMS" name="free_off_network_SMS" value="{{ plan['free_off_network_SMS'] or '0' }}" min="0">
        </div>
        <div class="form-group">
            <label for="maximum_on_network_call">Th·ªùi l∆∞·ª£ng t·ªëi ƒëa cu·ªôc g·ªçi n·ªôi m·∫°ng (Ph√∫t)</label>
            <input type="number" id="maximum_on_network_call" name="maximum_on_network_call" value="{{ plan['maximum_on_network_call'] or '0' }}" min="0" placeholder="Ph√∫t">
        </div>
        <div class="form-group">
            <label for="ON_SMS_cost">Chi ph√≠ SMS n·ªôi m·∫°ng (VND)</label>
            <input type="number" id="ON_SMS_cost" name="ON_SMS_cost" step="0.01" value="{{ plan['ON_SMS_cost'] or '0' }}" min="0" placeholder="VND">
        </div>
        <div class="form-group">
            <label for="ON_a_call_cost">Chi ph√≠ g·ªçi n·ªôi m·∫°ng (VND/ph√∫t)</label>
            <input type="number" id="ON_a_call_cost" name="ON_a_call_cost" step="0.01" value="{{ plan['ON_a_call_cost'] or '0' }}" min="0" placeholder="VND/ph√∫t">
        </div>
        <div class="form-group">
            <label for="object_type" class="required">H√¨nh th·ª©c thanh to√°n</label>
            <select id="object_type" name="object_type" required>
                <option value="TRATRUOC" {% if plan['object_type'] == 'TRATRUOC' %}selected{% endif %}>Tr·∫£ tr∆∞·ªõc</option>
                <option value="TRASAU" {% if plan['object_type'] == 'TRASAU' %}selected{% endif %}>Tr·∫£ sau</option>
            </select>
        </div>
        <div class="form-group">
            <label for="duration" class="required">Th·ªùi h·∫°n (ng√†y)</label>
            <input type="number" id="duration" name="duration" value="{{ plan['duration'] }}" min="1" required placeholder="Ng√†y">
        </div>
        <div class="form-group">
            <label for="is_active">K√≠ch ho·∫°t</label>
            <input type="checkbox" id="is_active" name="is_active" {% if plan['is_active'] %}checked{% endif %}>
        </div>
        <div class="form-group">
            <label for="auto_renew">T·ª± ƒë·ªông gia h·∫°n</label>
            <input type="checkbox" id="auto_renew" name="auto_renew" {% if plan['auto_renew'] %}checked{% endif %}>
        </div>
        <div class="form-group">
            <label for="service_id" class="required">ID D·ªãch v·ª•</label>
            <input type="number" id="service_id" name="service_id" value="{{ plan['service_id'] if plan['service_id'] else '' }}" min="1" required>
        </div>
        <div class="form-group">
            <label for="staff_id">ID Nh√¢n vi√™n</label>
            <input type="number" id="staff_id" name="staff_id" value="{{ plan['staff_id'] if plan['staff_id'] else '' }}" min="1">
        </div>
        <button type="submit" class="btn btn-submit">C·∫≠p nh·∫≠t</button>
        <a href="{{ url_for('plan.get_all_plans') }}" class="btn btn-cancel">H·ªßy</a>
    </form>
</div>

<script>
    document.getElementById('update-plan-form').addEventListener('submit', function(e) {
        const code = document.getElementById('code').value;
        const price = document.getElementById('price').value;
        const duration = document.getElementById('duration').value;
        const registrationSyntax = document.getElementById('registration_syntax').value;
        const renewalSyntax = document.getElementById('renewal_syntax').value;
        const cancelSyntax = document.getElementById('cancel_syntax').value;
        const serviceId = document.getElementById('service_id').value;
        const staffId = document.getElementById('staff_id').value;

        let errors = [];
        if (!code || code.length > 50) {
            errors.push('M√£ g√≥i c∆∞·ªõc kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng v√† kh√¥ng v∆∞·ª£t qu√° 50 k√Ω t·ª±');
            document.getElementById('code').classList.add('error');
        }
        if (!price || parseFloat(price) <= 0) {
            errors.push('Gi√° g√≥i c∆∞·ªõc ph·∫£i l√† s·ªë d∆∞∆°ng');
            document.getElementById('price').classList.add('error');
        }
        if (!duration || parseInt(duration) <= 0) {
            errors.push('Th·ªùi h·∫°n ph·∫£i l√† s·ªë d∆∞∆°ng');
            document.getElementById('duration').classList.add('error');
        }
        if (registrationSyntax && registrationSyntax.length > 255) {
            errors.push('C√∫ ph√°p ƒëƒÉng k√Ω kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 255 k√Ω t·ª±');
            document.getElementById('registration_syntax').classList.add('error');
        }
        if (renewalSyntax && renewalSyntax.length > 255) {
            errors.push('C√∫ ph√°p gia h·∫°n kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 255 k√Ω t·ª±');
            document.getElementById('renewal_syntax').classList.add('error');
        }
        if (cancelSyntax && cancelSyntax.length > 255) {
            errors.push('C√∫ ph√°p h·ªßy kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 255 k√Ω t·ª±');
            document.getElementById('cancel_syntax').classList.add('error');
        }
        if (!serviceId || parseInt(serviceId) <= 0) {
            errors.push('ID D·ªãch v·ª• ph·∫£i l√† s·ªë d∆∞∆°ng');
            document.getElementById('service_id').classList.add('error');
        }
        if (staffId && parseInt(staffId) <= 0) {
            errors.push('ID Nh√¢n vi√™n ph·∫£i l√† s·ªë d∆∞∆°ng');
            document.getElementById('staff_id').classList.add('error');
        }

        if (errors.length > 0) {
            alert(errors.join('\n'));
            e.preventDefault();
        }
    });
</script>
{% endblock %}