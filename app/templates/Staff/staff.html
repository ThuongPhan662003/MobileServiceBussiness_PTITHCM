{% extends 'admin_base.html' %}

{% block title %}Qu·∫£n l√Ω Nh√¢n vi√™n{% endblock %}

{% block content %}
<style>
    .container { width: 80%; margin: 40px auto; }
    .search-filter { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .search-filter input { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem; width: 100%; margin-right: 10px; }
    table { width: 100%; border-collapse: collapse; background-color: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
    th, td { padding: 14px; text-align: center; border: 1px solid #ddd; }
    th { background-color: #007bff; color: white; }
    tr:nth-child(even) { background-color: #f8f9fa; }
    tr:hover { background-color: #f1f1f1; }
    .status-active { color: green; font-weight: bold; }
    .status-locked { color: red; font-weight: bold; }
    .btn { padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; color: white; }
    .btn-lock { background-color: #e74c3c; }
    .btn-update { background-color: #3498db; margin-right: 5px; }
    .btn-add { background-color: #2ecc71; margin-bottom: 20px; padding: 10px 20px; font-size: 1rem; }
    .btn-update { background-color: #3498db; margin-right: 5px; }
    .btn-search { background-color: #2ecc71; margin-bottom: 20px; padding: 10px 20px; font-size: 1rem; }
    .btn:hover { opacity: 0.9; }
    #pagination button:disabled {
    background-color: #aaa !important;
    cursor: default;}

    /* Modal styles */
    .modal { 
        display: none; 
        position: fixed; 
        z-index: 1; 
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%; 
        background-color: rgba(0, 0, 0, 0.4); 
        padding-top: -10px; 
    }
    .modal-content { 
        background-color: #fefefe; 
        margin: 5% auto; 
        padding: 20px; 
        border: 1px solid #888; 
        width: 400px; 
        max-width: 90%;
        border-radius: 10px; 
    }
    .cancel { 
    color: white;
    background-color: red;
    }
    .submit{
        color: white; 
        background-color: green;
    }
    .reset{
        color: white; 
        background-color: blue;
    }

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; }
    .form-group input, .form-group select { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
    .form-grid {
    display: flex;
    gap: 20px;
    }

    .form-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .btn-group {
        display: flex;
        gap: 10px;
        margin-top: auto;
    }
    
    .search-grid {
        display: flex;
        gap: 20px;
    }
    
    .search-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .btn-group {
        display: flex;
        gap: 10px;
        margin-top: auto;
    }
    
    .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 4px;
    }

</style>

<div class="container">
    <h1 class="text-4xl font-bold text-gray-800 mb-6 flex items-center">
        <span class="mr-3">üë•</span> Qu·∫£n l√Ω Nh√¢n vi√™n
    </h1>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <ul class="flashes">
        {% for message in messages %}
        <li>{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}

    <button class="btn btn-add" onclick="openModal()">‚ûï Th√™m nh√¢n vi√™n</button>

    <!-- Modal Form Th√™m Nh√¢n vi√™n -->
<div id="myModal" class="modal">
    <div class="modal-content">
        <h2>Th√™m Nh√¢n vi√™n</h2>
        <form id="staffCreateForm" method="POST" action="/staffs/create" onsubmit="submitForm(event)">
            <div class="form-grid">
                <!-- C·ªôt tr√°i -->
                <div class="form-column">
                    <div class="form-group">
                        <label for="full_name">H·ªç t√™n</label>
                        <input type="text" id="full_name" name="full_name" required>
                    </div>
                    <div class="form-group">
                        <label for="card_id">M√£ s·ªë th·∫ª</label>
                        <input type="text" id="card_id" name="card_id" required >
                        <div id="card_id-error" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="phone">ƒêi·ªán tho·∫°i</label>
                        <input type="text" id="phone" name="phone" required >
                        <div id="phone-error" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" required >
                        <div id="email-error" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="birthday">Ng√†y sinh</label>
                        <input type="date" id="birthday" name="birthday" required >
                        <div id="birthday-error" class="error-message"></div>
                    </div>
                </div>

                <!-- C·ªôt ph·∫£i -->
                <div class="form-column">
                    <div class="form-group">
                        <label for="gender">Gi·ªõi t√≠nh</label>
                        <select id="gender" name="gender" required>
                            <option value="Nam">Nam</option>
                            <option value="N·ªØ">N·ªØ</option>
                            <option value="Kh√°c">Kh√°c</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="role_name">Vai tr√≤</label>
                        <select id="role_name" name="role_name" required>
                            <option value="Qu·∫£n l√Ω">Qu·∫£n l√Ω</option>
                            <option value="Nh√¢n vi√™n">Nh√¢n vi√™n</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="username">T√™n ƒëƒÉng nh·∫≠p</label>
                        <input type="text" id="username" name="username" required>
                        <div id="username-error" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="password">M·∫≠t kh·∫©u</label>
                        <div style="position: relative;">
                        <input type="password" id="password" name="password" class="form-control" required>
                        <span id="togglePassword" style="
                            position: absolute;
                            top: 50%;
                            right: 10px;
                            transform: translateY(-50%);
                            cursor: pointer;
                        ">üëÅ</span>
                        </div>
                    </div>
                    <!-- N√∫t x√°c nh·∫≠n v√† h·ªßy -->
                    <div class="form-group btn-group">
                        <button type="submit" class="btn submit">X√°c nh·∫≠n</button>
                        <button type="button" class="btn cancel" onclick="closeModal()">H·ªßy</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>


<script>

    const togglePassword = document.getElementById("togglePassword");
    const passwordField = document.getElementById("password");

    togglePassword.addEventListener("click", function () {
    const type = passwordField.getAttribute("type") === "password" ? "text" : "password";
    passwordField.setAttribute("type", type);

    // ƒê·ªïi bi·ªÉu t∆∞·ª£ng üëÅ/üôà (n·∫øu th√≠ch)
    this.textContent = type === "password" ? "üëÅ" : "üôà";
    });
    // M·ªü modal
    function openModal() {
        document.getElementById("myModal").style.display = "block";
    }

    // ƒê√≥ng modal
    function closeModal() {
        document.getElementById("myModal").style.display = "none";
    }

    // ƒê·∫£m b·∫£o ƒë√≥ng modal n·∫øu ng∆∞·ªùi d√πng click ra ngo√†i modal
    // window.onclick = function(event) {
        // if (event.target == document.getElementById("myModal")) {
            // closeModal();
        // }
    // }


    function submitForm(event) {
    event.preventDefault();
    const form = document.getElementById("staffCreateForm");
    const formData = new FormData(form);

    // X√≥a c√°c th√¥ng b√°o l·ªói c≈©
    document.querySelectorAll('.error-message').forEach(el => el.innerText = "");

    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(async response => {
        let data;
        try {
            data = await response.json();
        } catch (e) {
            throw new Error("Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá t·ª´ server.");
        }

        if (response.ok) {
            // Th√†nh c√¥ng
            if (data.message) {
                alert(data.message);
                closeModal();
                location.reload();
            }
        } else {
            // L·ªói t·ª´ backend (status 400, 500, ...)
            if (data.error) {
                if (data.error.includes("t√™n ƒëƒÉng nh·∫≠p")) {
                    const el = document.getElementById("username-error");
                    if (el) el.innerText = data.error;
                } else if (data.error.includes("M√£ s·ªë th·∫ª")) {
                    const el = document.getElementById("card_id-error");
                    if (el) el.innerText = data.error;
                } else if (data.error.includes("S·ªë ƒëi·ªán tho·∫°i")) {
                    const el = document.getElementById("phone-error");
                    if (el) el.innerText = data.error;
                } else if (data.error.includes("Email")) {
                    const el = document.getElementById("email-error");
                    if (el) el.innerText = data.error;
                } else if (data.error.includes("Ng√†y sinh")) {
                    const el = document.getElementById("birthday-error");
                    if (el) el.innerText = data.error;
                } else {
                    alert(data.error); // fallback l·ªói chung
                }
            }

        
    }    })

    .catch(error => {
        // ‚úÖ In ra ƒë√∫ng l·ªói th·∫≠t s·ª±
        alert(error.message || "ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.");
        console.error("L·ªói khi fetch:", error);
    });
}



</script>




<!-- N√∫t m·ªü form t√¨m ki·∫øm -->
<button class="btn btn-search" onclick="toggleSearchForm()">üîç T√¨m ki·∫øm n√¢ng cao</button>

<!-- Form t√¨m ki·∫øm n√¢ng cao -->
<div id="searchFormContainer" style="display: none; margin-top: 20px;">
    <form id="advancedSearchForm" method="GET" action="/staffs">
        <div class="search-grid">
            <!-- C·ªôt tr√°i -->
            <div class="search-column">
                <div class="form-group">
                    <label for="search_full_name">H·ªç t√™n</label>
                    <input type="text" id="search_full_name" name="full_name">
                </div>
                <div class="form-group">
                    <label for="search_account_id">M√£ t√†i kho·∫£n</label>
                    <input type="text" id="search_account_id" name="account_id">
                </div>
                <div class="form-group">
                    <label for="search_gender">Gi·ªõi t√≠nh</label>
                    <select id="search_gender" name="gender">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="Nam">Nam</option>
                        <option value="N·ªØ">N·ªØ</option>
                        <option value="Kh√°c">Kh√°c</option>
                    </select>
                </div>
            </div>

            <!-- C·ªôt ph·∫£i -->
            <div class="search-column">
                <div class="form-group">
                    <label for="search_status">Tr·∫°ng th√°i</label>
                    <select id="search_status" name="is_active">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="1">ƒêang ho·∫°t ƒë·ªông</option>
                        <option value="0">ƒê√£ kh√≥a</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="search_role">Vai tr√≤</label>
                    <select id="search_role" name="role">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="Qu·∫£n l√Ω">Qu·∫£n l√Ω</option>
                        <option value="Nh√¢n vi√™n">Nh√¢n vi√™n</option>
                    </select>
                </div>
                <div class="form-group btn-group">
                    <button type="submit" class="btn submit">T√¨m ki·∫øm</button>
                    <button type="button" class="btn reset" onclick="resetSearchForm()">ƒê·∫∑t l·∫°i</button>
                    <button type="button" class="btn cancel" onclick="toggleSearchForm()">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    function toggleSearchForm() {
    const form = document.getElementById("searchFormContainer");
    form.style.display = form.style.display === "none" ? "block" : "none";
    }

    function resetSearchForm() {
        document.getElementById("advancedSearchForm").reset();
        window.location.href = "/staffs";  // Reload l·∫°i trang /staffs ƒë·ªÉ hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh
    }

</script>


    <table>
        <thead>
            <tr>
                <th>Th·ª© t·ª±</th>
                <th>H·ªç t√™n</th>
                <th>M√£ s·ªë th·∫ª</th>
                <th>ƒêi·ªán tho·∫°i</th>
                <th>Email</th>
                <th>Ng√†y sinh</th>
                <th>Gi·ªõi t√≠nh</th>
                <th>Tr·∫°ng th√°i</th>
                <th>M√£ t√†i kho·∫£n</th>
                <th>Vai tr√≤</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody id="staffTableBody">
            {% for staff in staffs %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ staff.full_name }}</td>
                <td>{{ staff.card_id }}</td>
                <td>{{ staff.phone }}</td>
                <td>{{ staff.email }}</td>
                <td>{{ staff.birthday }}</td>
                <td>{{ staff.gender }}</td>
                <td class="{{ 'status-active' if staff.is_active else 'status-locked' }}">
                    {{ 'ƒêang ho·∫°t ƒë·ªông' if staff.is_active else 'ƒê√£ kh√≥a' }}
                </td>
                <td>{{ staff.account_id }}</td>
                <td>{{ staff.role_name }}</td>
                <td>
                    <button class="btn btn-update" onclick='openUpdateModal({{ staff|tojson|safe }})' {% if not staff.is_active %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>üõ† C·∫≠p nh·∫≠t</button>
                    {% if staff.is_active %}
                        <button class="btn btn-lock" data-staff-id="{{ staff.id }}" onclick="lockStaff(this)">üîí Kh√≥a</button>
                    {% else %}
                        <button class="btn btn-lock" disabled style="opacity: 0.5; cursor: not-allowed;">üîí ƒê√£ kh√≥a</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal Form C·∫≠p nh·∫≠t Nh√¢n vi√™n -->
<div id="updateModal" class="modal">
    <div class="modal-content">
        <h2>C·∫≠p nh·∫≠t Nh√¢n vi√™n</h2>
        <form id="staffUpdateForm" method="POST" onsubmit="submitUpdateForm(event)">
            <div class="form-grid">
                <!-- C·ªôt tr√°i -->
                <div class="form-column">
                    <div class="form-group">
                        <label for="update_full_name">H·ªç t√™n</label>
                        <input type="text" id="update_full_name" name="full_name" required>
                    </div>
                    <div class="form-group">
                        <label for="update_phone">ƒêi·ªán tho·∫°i</label>
                        <input type="text" id="update_phone" name="phone" required>
                        <div id="update_phone-error" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="update_email">Email</label>
                        <input type="email" id="update_email" name="email" required>
                        <div id="update_email-error" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="update_birthday">Ng√†y sinh</label>
                        <input type="date" id="update_birthday" name="birthday" required>
                        <div id="update_birthday-error" class="error-message"></div>
                    </div>
                </div>

                <!-- C·ªôt ph·∫£i -->
                <div class="form-column">
                    <div class="form-group">
                        <label for="update_gender">Gi·ªõi t√≠nh</label>
                        <select id="update_gender" name="gender" required>
                            <option value="Nam">Nam</option>
                            <option value="N·ªØ">N·ªØ</option>
                            <option value="Kh√°c">Kh√°c</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="update_role">Vai tr√≤</label>
                        <select id="update_role" name="role_name" required>
                            <option value="Qu·∫£n l√Ω">Qu·∫£n l√Ω</option>
                            <option value="Nh√¢n vi√™n">Nh√¢n vi√™n</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="update_password">M·∫≠t kh·∫©u</label>
                        <div style="position: relative;">
                            <input type="password" id="update_password" name="password" class="form-control" > 
                            <span id="toggleUpdatePassword" style="
                                position: absolute;
                                top: 50%;
                                right: 10px;
                                transform: translateY(-50%);
                                cursor: pointer;
                            ">üëÅ</span>
                        </div>
                    </div>
                    <div class="form-group btn-group">
                        <button type="submit" class="btn submit">X√°c nh·∫≠n</button>
                        <button type="button" class="btn cancel" onclick="closeUpdateModal()">H·ªßy</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>


<script>
    const toggleUpdatePassword = document.getElementById("toggleUpdatePassword");
    const updatePasswordField = document.getElementById("update_password");

    toggleUpdatePassword.addEventListener("click", function () {
        const type = updatePasswordField.getAttribute("type") === "password" ? "text" : "password";
        updatePasswordField.setAttribute("type", type);

        this.textContent = type === "password" ? "üëÅ" : "üôà";
    });



    // M·ªü modal C·∫≠p nh·∫≠t v√† ƒëi·ªÅn d·ªØ li·ªáu v√†o form
    function openUpdateModal(staff) {
    console.log(staff)
    document.getElementById("updateModal").style.display = "block";
    document.getElementById("update_full_name").value = staff.full_name;
    document.getElementById("update_phone").value = staff.phone;
    document.getElementById("update_email").value = staff.email;
    document.getElementById("update_birthday").value = new Date(staff.birthday).toISOString().split('T')[0];
    document.getElementById("update_gender").value = staff.gender;
    document.getElementById("update_role").value = staff.role_name;
    document.getElementById("update_password").value = ""; // m·∫≠t kh·∫©u s·∫Ω do admin nh·∫≠p l·∫°i
    document.getElementById("staffUpdateForm").setAttribute("action", "/staffs/update/" + staff.id);
}


    // ƒê√≥ng modal C·∫≠p nh·∫≠t
    function closeUpdateModal() {
        document.getElementById("updateModal").style.display = "none";
    }

    // G·ª≠i form c·∫≠p nh·∫≠t nh√¢n vi√™n
    async function submitUpdateForm(event) {
        event.preventDefault(); // Ng·ª´ng h√†nh ƒë·ªông m·∫∑c ƒë·ªãnh (kh√¥ng chuy·ªÉn trang)
        const form = document.getElementById("staffUpdateForm");
        const formData = new FormData(form);

        // X√≥a c√°c th√¥ng b√°o l·ªói c≈©
        document.querySelectorAll('.error-message').forEach(el => el.innerText = "");

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData
            });

            let data;
            try {
                data = await response.json();
            } catch (e) {
                throw new Error("Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá t·ª´ server.");
            }

            if (response.ok) {
                if (data.message) {
                    alert('C·∫≠p nh·∫≠t nh√¢n vi√™n th√†nh c√¥ng!');
                    closeUpdateModal();
                    location.reload(); // L√†m m·ªõi trang ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch
                }
            } else {
                if (data.error) {
                    if (data.error.includes("S·ªë ƒëi·ªán tho·∫°i")) {
                        const el = document.getElementById("update_phone-error");
                        if (el) el.innerText = data.error;
                    } else if (data.error.includes("Email")) {
                        const el = document.getElementById("update_email-error");
                        if (el) el.innerText = data.error;
                    } else if (data.error.includes("Ng√†y sinh")) {
                        const el = document.getElementById("update_birthday-error");
                        if (el) el.innerText = data.error;
                    } else {
                        alert(data.error); // fallback l·ªói chung
                    }
                }
            }
        } catch (error) {
            // ‚úÖ In ra ƒë√∫ng l·ªói th·∫≠t s·ª±
            alert(error.message || "ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.");
            console.error("L·ªói khi fetch:", error);
        }
    }
</script>


<div id="pagination" style="text-align:center; margin-top:20px;"></div>
<script>
    const rowsPerPage = 8;
    const table = document.getElementById("staffTableBody");
    const rows = Array.from(table.getElementsByTagName("tr"));
    const pagination = document.getElementById("pagination");
    let currentPage = 1;

    function displayPage(page) {
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        rows.forEach((row, index) => {
            row.style.display = index >= start && index < end ? "" : "none";
        });

        currentPage = page;
        renderPagination();
    }

    function renderPagination() {
        const pageCount = Math.ceil(rows.length / rowsPerPage);
        pagination.innerHTML = "";

        // N√∫t Prev
        const prevBtn = document.createElement("button");
        prevBtn.innerHTML = "‚óÄ";
        prevBtn.className = "btn btn-update";
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => displayPage(currentPage - 1);
        pagination.appendChild(prevBtn);

        // C√°c n√∫t s·ªë trang
        for (let i = 1; i <= pageCount; i++) {
            const btn = document.createElement("button");
            btn.textContent = i;
            btn.className = "btn btn-update";
            btn.style.margin = "0 3px";
            btn.disabled = i === currentPage;
            btn.onclick = () => displayPage(i);
            pagination.appendChild(btn);
        }

        // N√∫t Next
        const nextBtn = document.createElement("button");
        nextBtn.innerHTML = "‚ñ∂";
        nextBtn.className = "btn btn-update";
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => displayPage(currentPage + 1);
        pagination.appendChild(nextBtn);
    }

    // Kh·ªüi t·∫°o khi load trang
    displayPage(1);
</script>



<script>
    // Kh√≥a nh√¢n vi√™n
    function lockStaff(button) {
    const staffId = button.getAttribute("data-staff-id");
    if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kh√≥a nh√¢n vi√™n n√†y kh√¥ng?")) {
        fetch(`/staffs/lock/${staffId}`, { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert("C√≥ l·ªói x·∫£y ra khi kh√≥a nh√¢n vi√™n.");
                }
            });
    }
}

</script>
{% endblock %}
