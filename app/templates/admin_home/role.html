{% extends 'admin_home/admin_base.html' %}

{% block title %}Qu·∫£n l√Ω Nh√≥m Quy·ªÅn{% endblock %}

{% block content %}
<style>
    /* General Styling */
    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        background-color: #f5f6fa;
        color: #333;
        margin: 0;
        padding: 0;
    }

    h1 {
        font-size: 2.5rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
    }

    h1 span {
        margin-right: 10px;
    }

    .container {
        width: 80%;
        margin: 40px auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background-color: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    th,
    td {
        padding: 14px;
        text-align: center;
        border: 1px solid #ddd;
    }

    th {
        background-color: #007bff;
        color: white;
        font-weight: bold;
    }

    tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    tr:hover {
        background-color: #f1f1f1;
    }

    .toggle-btn {
        cursor: pointer;
        transition: transform 0.3s;
        font-size: 1.2rem;
    }

    .toggle-btn.active {
        transform: rotate(180deg);
    }

    .staff-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .staff-table th,
    .staff-table td {
        padding: 10px;
        border: 1px solid #ccc;
        text-align: center;
    }

    .staff-table th {
        background-color: #f1f1f1;
        color: #333;
    }

    .staff-table td {
        color: #333;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 50%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .modal-header h3 {
        font-size: 1.5rem;
        font-weight: bold;
    }

    .modal-header button {
        background: transparent;
        border: none;
        color: #f44336;
        font-size: 1.5rem;
        cursor: pointer;
    }

    .modal-content button {
        background-color: #4CAF50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .modal-content button:hover {
        background-color: #45a049;
    }

    .modal-content .close {
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        padding: 10px;
    }

    .staff-table {
        max-height: 300px;
        overflow-y: auto;
    }

    .staff-table thead,
    .staff-table tbody tr {
        display: table;
        width: 100%;
        table-layout: fixed;
    }

    .flashes {
        list-style: none;
        padding: 0;
        margin-bottom: 20px;
    }

    .flashes li {
        background: #ffdddd;
        border-left: 4px solid #f44336;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
    }
</style>

<div class="container">
    <h1 class="text-4xl font-bold text-gray-800 mb-6 flex items-center">
        <span class="mr-3">üë•</span> Danh s√°ch Nh√≥m Quy·ªÅn
    </h1>

    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>M√£ Nh√≥m</th>
                    <th>T√™n Nh√≥m Quy·ªÅn</th>
                    <th>S·ªë nh√¢n vi√™n</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                {% for role in role_groups %}
                <tr>
                    <td>
                        <button onclick="toggleRow('{{ role.id }}')" id="toggle-btn-{{ role.id }}" class="toggle-btn">
                            <!-- S·ª≠ d·ª•ng h√¨nh tam gi√°c Unicode -->
                            <span id="triangle-{{ role.id }}" class="triangle-down">‚ñº</span>
                        </button>
                    </td>
                    <td>{{ role.id }}</td>
                    <td class="font-semibold">{{ role.role_name }}</td>
                    <td id="staff-count-{{ role.id }}">-</td>
                    <td>
                        <button onclick="openAddModal('{{ role.id }}')"
                            class="bg-green-500 text-white px-3 py-1 rounded">‚ûï Th√™m</button>
                        <button onclick="openPermissionModal('{{ role.id }}')"
                            class="bg-blue-500 text-white px-3 py-1 rounded">üîß Qu·∫£n l√Ω quy·ªÅn</button>
                    </td>
                </tr>
                <tr id="row{{ role.id }}" class="hidden">
                    <td colspan="5">
                        <div id="staff-list-{{ role.id }}" class="text-gray-500 italic"></div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Th√™m Nh√¢n Vi√™n -->
<div id="addStaffModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="text-lg font-semibold">Th√™m Nh√¢n Vi√™n</h3>
            <button onclick="closeModal('addStaffModal')" class="close">&times;</button>
        </div>
        <ul id="staffList" class="mt-4"></ul>
        <button onclick="confirmAddStaff()" class="bg-blue-500 text-white px-4 py-2 rounded mt-4">Th√™m</button>
    </div>
</div>

<!-- Modal Qu·∫£n l√Ω Quy·ªÅn -->
<div id="permissionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="text-lg font-semibold text-center">üéõÔ∏è Qu·∫£n l√Ω ch·ª©c nƒÉng nh√≥m</h3>
            <button onclick="closeModal('permissionModal')" class="close">&times;</button>
        </div>
        <h4 class="mt-4 font-semibold">üîπ Ch·ª©c nƒÉng hi·ªán t·∫°i:</h4>
        <div class="staff-table">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>T√™n ch·ª©c nƒÉng</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="roleFunctionsList">
                    <tr>
                        <td colspan="2" class="text-gray-500 italic">ƒêang t·∫£i...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <h4 class="mt-4 font-semibold">‚ûï Ch·ªçn quy·ªÅn b·ªï sung:</h4>
        <div id="permissionList" class="p-2 bg-gray-100 rounded-lg" style="max-height: 200px; overflow-y: auto;">
            <!-- C√°c quy·ªÅn b·ªï sung s·∫Ω hi·ªÉn th·ªã d∆∞·ªõi d·∫°ng m·ªói quy·ªÅn chi·∫øm m·ªôt d√≤ng -->
        </div>
        <button onclick="savePermissions()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg mt-4 w-full"
            style="margin-top: 10px;">üíæ L∆∞u thay ƒë·ªïi</button>
    </div>
</div>

<script>
    let selectedRoleId = null;

    function toggleRow(roleId) {
        let row = document.getElementById('row' + roleId);
        let button = document.getElementById('toggle-btn-' + roleId);
        let staffList = document.getElementById('staff-list-' + roleId);
        let staffCount = document.getElementById('staff-count-' + roleId);

        if (row.style.display === "none" || row.style.display === "") {
            row.style.display = "table-row";
            button.classList.add("active");

            if (!staffList.dataset.loaded) {
                staffList.innerHTML = 'ƒêang t·∫£i...';
                fetch(`/role_groups/staffsByRoleGroup/${roleId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log("D·ªØ li·ªáu t·ª´ API:", data);
                        if (data.length > 0) {
                            staffList.innerHTML = `
                            <table class='staff-table'>
                                <thead>
                                    <tr>
                                        <th>T√™n Nh√¢n Vi√™n</th>
                                        <th>Email</th>
                                        <th>X√≥a</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.map(staff => `
                                        <tr>
                                            <td>${staff.full_name}</td>
                                            <td>${staff.email}</td>
                                            <td><button onclick="removeStaff(${staff.id}, ${roleId})" class='text-red-500'>‚ùå</button></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>`;
                            staffCount.innerText = data.length;  // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng nh√¢n vi√™n
                        } else {
                            staffList.innerHTML = '<p class="text-gray-500 italic">Ch∆∞a c√≥ nh√¢n vi√™n trong nh√≥m n√†y.</p>';
                            staffCount.innerText = '0';
                        }
                        staffList.dataset.loaded = "true";
                    })
                    .catch(error => {
                        staffList.innerHTML = '<p class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu.</p>';
                    });
            }
        } else {
            row.style.display = "none";
            button.classList.remove("active");
        }
    }

    function removeStaff(staffId, roleId) {
        fetch(`/admin/roles/removeStaff/${roleId}/${staffId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(() => toggleRow(roleId));
    }

    function openAddModal(roleId) {
        selectedRoleId = roleId;
        document.getElementById('addStaffModal').style.display = 'flex';
        let staffList = document.getElementById('staffList');
        staffList.innerHTML = 'ƒêang t·∫£i...';

        fetch('/role_groups/etAvailableStaffs')
            .then(response => response.json())
            .then(data => {
                staffList.innerHTML = data.staffs.map(staff =>
                    `<li><input type='checkbox' value='${staff.id}'> ${staff.full_name} (${staff.email})</li>`
                ).join('');
            });
    }

    function confirmAddStaff() {
        let selectedStaffs = Array.from(document.querySelectorAll('#staffList input:checked')).map(cb => cb.value);
        fetch(`/admin/staffs/addStaff/${selectedRoleId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ staff_ids: selectedStaffs })
        }).then(() => {
            closeModal('addStaffModal');
            toggleRow(selectedRoleId);
        });
    }

    function openPermissionModal(roleId) {
        selectedRoleId = roleId;
        document.getElementById('permissionModal').style.display = 'flex';
        let permissionList = document.getElementById('permissionList');
        let roleFunctionsList = document.getElementById('roleFunctionsList');

        permissionList.innerHTML = '<p class="text-gray-500 italic">ƒêang t·∫£i...</p>';
        roleFunctionsList.innerHTML = '<tr><td colspan="3" class="text-gray-500 italic">ƒêang t·∫£i...</td></tr>';

        fetch(`/role_groups/functions/${roleId}`)
            .then(response => response.json())
            .then(data => {
                console.log("D·ªØ li·ªáu t·ª´ API:", data);

                // X·ª≠ l√Ω danh s√°ch quy·ªÅn ƒë√£ ƒë∆∞·ª£c g√°n
                let assignedFunctions = data.assigned_functions; // S·ª≠ d·ª•ng assigned_functions
                roleFunctionsList.innerHTML = assignedFunctions.length > 0
                    ? assignedFunctions.map((perm, index) => `
                <tr>
                    <td>${perm.id}</td>
                    <td>${perm.function_name || 'N/A'}</td>
                    <td><button onclick="removeFunction(${perm.id}, ${roleId})" class='text-red-500'>‚ùå</button></td>
                </tr>
            `).join('')
                    : `<tr><td colspan="2" class="text-gray-500 italic">Nh√≥m n√†y ch∆∞a c√≥ quy·ªÅn.</td></tr>`;

                // X·ª≠ l√Ω danh s√°ch quy·ªÅn ch∆∞a ƒë∆∞·ª£c g√°n
                let unassignedFunctions = data.unassigned_functions; // S·ª≠ d·ª•ng unassigned_functions
                permissionList.innerHTML = unassignedFunctions.length > 0
                    ? unassignedFunctions.map(perm => `
                <div class="flex items-center bg-white p-2 rounded shadow-sm border cursor-pointer mb-2">
                    <input type="checkbox" value="${perm.id}" class="mr-2">
                    ${perm.function_name}
                </div>
            `).join('')
                    : '<p class="text-gray-500 italic">Kh√¥ng c√≥ quy·ªÅn n√†o c√≥ th·ªÉ th√™m.</p>';
            })
            .catch(error => {
                console.error("L·ªói Fetch API:", error);
                permissionList.innerHTML = '<p class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu!</p>';
                roleFunctionsList.innerHTML = '<tr><td colspan="2" class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu!</td></tr>';
            });

    }
    function removeFunction(functionId, roleId) {
        // Hi·ªÉn th·ªã h·ªôp tho·∫°i x√°c nh·∫≠n
        const confirmation = confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·ª©c nƒÉng n√†y?");

        if (!confirmation) {
            // N·∫øu ng∆∞·ªùi d√πng nh·∫•n "Cancel", h·ªßy b·ªè thao t√°c x√≥a
            return;
        }

        fetch(`/role_groups/remove_function/${roleId}/${functionId}`, { method: 'DELETE' })
            .then(response => {
                // Ki·ªÉm tra n·∫øu ph·∫£n h·ªìi l√† h·ª£p l·ªá (HTTP status 200-299)
                if (!response.ok) {
                    throw new Error('L·ªói khi x√≥a ch·ª©c nƒÉng');
                }
                return response.json(); // Chuy·ªÉn ƒë·ªïi ph·∫£n h·ªìi th√†nh JSON n·∫øu h·ª£p l·ªá
            })
            .then(data => {
                console.log("D·ªØ li·ªáu tr·∫£ v·ªÅ t·ª´ API:", data);
                // Ki·ªÉm tra n·∫øu d·ªØ li·ªáu tr·∫£ v·ªÅ c√≥ thu·ªôc t√≠nh message
                if (data.message) {
                    alert(data.message);  // Hi·ªÉn th·ªã th√¥ng b√°o tr·∫£ v·ªÅ t·ª´ API
                    openPermissionModal(selectedRoleId); // C·∫≠p nh·∫≠t l·∫°i danh s√°ch quy·ªÅn
                    // C·∫≠p nh·∫≠t giao di·ªán sau khi x√≥a ch·ª©c nƒÉng
                    // (C√≥ th·ªÉ l√† ·∫©n, x√≥a ho·∫∑c c·∫≠p nh·∫≠t l·∫°i danh s√°ch ch·ª©c nƒÉng)
                } else {
                    alert('C√≥ l·ªói x·∫£y ra khi x√≥a ch·ª©c nƒÉng');
                }
            })
            .catch(error => {
                // X·ª≠ l√Ω l·ªói n·∫øu kh√¥ng th·ªÉ k·∫øt n·ªëi ho·∫∑c d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
                console.error("L·ªói Fetch API:", error);
                alert("ƒê√£ x·∫£y ra l·ªói khi x√≥a ch·ª©c nƒÉng.");
            });
    };

    function savePermissions() {
        // L·∫•y danh s√°ch c√°c permission_ids ƒë√£ ch·ªçn
        let selectedPermissions = Array.from(document.querySelectorAll('#permissionList input:checked'))
            .map(cb => cb.value);

        // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ quy·ªÅn n√†o ƒë∆∞·ª£c ch·ªçn
        if (selectedPermissions.length === 0) {
            alert("B·∫°n ch∆∞a ch·ªçn quy·ªÅn n√†o ƒë·ªÉ th√™m.");
            return;
        }

        // Chuy·ªÉn m·∫£ng c√°c ID th√†nh chu·ªói JSON
        let permissionIdsJSON = JSON.stringify(selectedPermissions.map(id => parseInt(id))); // Chuy·ªÉn c√°c gi√° tr·ªã th√†nh ki·ªÉu s·ªë n·∫øu c·∫ßn
        console.log("C√°c permission_ids ƒë√£ ch·ªçn:", permissionIdsJSON);

        // G·ª≠i request POST t·ªõi server v·ªõi chu·ªói permission_ids trong ƒë·ªãnh d·∫°ng JSON
        fetch(`/role_groups/add_funcs/${selectedRoleId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ permission_ids: permissionIdsJSON })
        })
            .then(response => response.json())
            .then(data => {
                console.log("D·ªØ li·ªáu tr·∫£ v·ªÅ t·ª´ API:", data);
                // Ki·ªÉm tra k·∫øt qu·∫£ tr·∫£ v·ªÅ t·ª´ API
                if (data.success) {
                    closeModal('permissionModal');  // ƒê√≥ng modal khi th√†nh c√¥ng
                    openPermissionModal(selectedRoleId); // C·∫≠p nh·∫≠t l·∫°i danh s√°ch quy·ªÅn
                    alert("C·∫≠p nh·∫≠t quy·ªÅn th√†nh c√¥ng!");
                } else {
                    alert(data.error || "L·ªói x·∫£y ra khi l∆∞u thay ƒë·ªïi."); // N·∫øu c√≥ l·ªói tr·∫£ v·ªÅ t·ª´ API
                }
            })
            .catch(error => {
                console.error("L·ªói :", error);
                console.error("L·ªói Fetch API:", error);
                alert("ƒê√£ x·∫£y ra l·ªói khi l∆∞u thay ƒë·ªïi.");
            });
    }


    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
</script>
{% endblock %}