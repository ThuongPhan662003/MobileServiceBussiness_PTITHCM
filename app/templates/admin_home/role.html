{% extends 'admin_base.html' %}

{% block title %}Qu·∫£n L√Ω Nh√≥m Quy·ªÅn{% endblock %}

{% block content %}
<style>
    /* .role-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
        font-family: 'Roboto', sans-serif;
    } */
    .scrollable-list {
        max-height: 300px;
        /* Chi·ªÅu cao t·ªëi ƒëa */
        overflow-y: auto;
        /* K√≠ch ho·∫°t scroll d·ªçc */
        padding-right: 5px;
        /* Th√™m kho·∫£ng c√°ch n·∫øu c√≥ scrollbar */
    }

    .role-container {
        width: 95%;
        margin: 40px auto;
        padding: 0 10px;
        font-family: 'Roboto', sans-serif;

    }

    html,
    body {
        height: auto;
        min-height: 100vh;
        overflow-y: auto;
    }

    .role-table {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        width: 100%;
        max-height: 1000px;
        overflow-y: auto;
        overflow-x: auto;
        display: block;

    }

    .role-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .role-table thead {
        position: sticky;
        top: 0;
        z-index: 1;
        background: #ee2b47;
    }

    .role-table th:nth-child(1),
    .role-table td:nth-child(1) {
        width: 5%;
        text-align: center;
    }

    .role-table th:nth-child(2),
    .role-table td:nth-child(2) {
        width: 15%;
        text-align: center;
    }

    .role-table th:nth-child(3),
    .role-table td:nth-child(3) {
        width: 35%;
        text-align: left;
    }

    .role-table th:nth-child(4),
    .role-table td:nth-child(4) {
        width: 15%;
        text-align: center;
    }

    /* T√πy ch·ªânh thanh cu·ªôn */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .role-container {
        width: 95%;
        margin: 40px auto;
        padding: 0 10px;
        font-family: 'Roboto', sans-serif;
    }

    .role-table {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        width: 100%;
        overflow-x: auto;
        overflow-y: auto;
        max-height: 500px;
        /* ‚úÖ Gi·ªõi h·∫°n chi·ªÅu cao b·∫£ng */
        display: block;
        padding-right: 5px;
    }


    /* ƒê·∫£m b·∫£o b·∫£ng b√™n trong role-table c≈©ng r·ªông 100% */
    .role-table table {
        width: 100%;
        border-collapse: collapse;
        /* ƒê·∫£m b·∫£o kh√¥ng c√≥ kho·∫£ng c√°ch th·ª´a */
    }

    /* ƒê·∫∑t chi·ªÅu r·ªông c·ªë ƒë·ªãnh cho c√°c c·ªôt */
    .role-table th:nth-child(1),
    .role-table td:nth-child(1) {
        width: 5%;
        /* C·ªôt # (n√∫t toggle) */
        text-align: center;
    }

    .role-table th:nth-child(2),
    .role-table td:nth-child(2) {
        width: 15%;
        /* C·ªôt M√£ Nh√≥m */
        text-align: center;
    }

    .role-table th:nth-child(3),
    .role-table td:nth-child(3) {
        width: 35%;
        /* C·ªôt T√™n Nh√≥m Quy·ªÅn */
        text-align: left;
        /* CƒÉn tr√°i cho t√™n nh√≥m quy·ªÅn */
    }

    .role-table th:nth-child(4),
    .role-table td:nth-child(4) {
        width: 15%;
        /* C·ªôt S·ªë Nh√¢n Vi√™n */
        text-align: center;
    }

    .role-table th:nth-child(5),
    .role-table td:nth-child(5) {
        width: 30%;
        /* C·ªôt Thao T√°c */
        text-align: center;
    }

    /* ƒê·∫£m b·∫£o b·∫£ng nh√¢n vi√™n con c≈©ng cƒÉn ƒë·ªÅu */
    .staff-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background: #fafafa;
        border-radius: 8px;
    }

    .staff-table th:nth-child(1),
    .staff-table td:nth-child(1) {
        width: 40%;
        /* C·ªôt T√™n Nh√¢n Vi√™n */
        text-align: left;
    }

    .staff-table th:nth-child(2),
    .staff-table td:nth-child(2) {
        width: 40%;
        /* C·ªôt Email */
        text-align: left;
    }

    .staff-table th:nth-child(3),
    .staff-table td:nth-child(3) {
        width: 20%;
        /* C·ªôt X√≥a */
        text-align: center;
    }

    .role-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .role-header h1 {
        font-size: 2rem;
        color: #222;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* .role-table {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    } */

    .role-table th {
        background: #ee2b47;
        color: white;
        font-weight: 600;
        padding: 15px;
        text-align: center;
    }

    .role-table td {
        padding: 15px;
        vertical-align: middle;
        color: #555;
        font-size: 0.95rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .role-table tr:hover {
        background: #fafafa;
    }

    .toggle-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        color: #007bff;
        transition: transform 0.3s ease, color 0.3s ease;
    }

    .toggle-btn.active {
        transform: rotate(180deg);
        color: #ee2b47;
    }

    .staff-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background: #fafafa;
        border-radius: 8px;
    }

    .staff-table th {
        background: #f1f1f1;
        color: #333;
        padding: 12px;
        font-weight: 600;
        text-align: center;
    }

    .staff-table td {
        padding: 12px;
        color: #555;
        text-align: center;
        border-bottom: 1px solid #eee;
    }

    .btn-action {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.3s ease;
        color: white;
        border: none;
    }

    .btn-add-staff {
        background: linear-gradient(90deg, #00b14f, #00d15e);
    }

    .btn-add-staff:hover {
        background: linear-gradient(90deg, #009b43, #00b952);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 177, 79, 0.4);
    }

    .btn-manage-perms {
        background: linear-gradient(90deg, #007bff, #00a1ff);
    }

    .btn-manage-perms:hover {
        background: linear-gradient(90deg, #0056b3, #0087d1);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
    }

    .btn-remove {
        color: #ee2b47;
        background: none;
        border: none;
        font-size: 1rem;
        cursor: pointer;
    }

    .btn-remove:hover {
        color: #d81f3a;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: #fff;
        max-width: 600px;
        width: 90%;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        animation: fadeIn 0.3s ease-in-out;
    }

    .modal-header {
        padding: 20px;
        background: #fafafa;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 1.5rem;
        color: #222;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #666;
        cursor: pointer;
    }

    .modal-body {
        padding: 20px;
        max-height: 60vh;
        overflow-y: auto;
    }

    .modal-body ul {
        list-style: none;
        padding: 0;
    }

    .modal-body li {
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #f0f0f0;
        text-align: right;
    }

    .btn-save {
        padding: 10px 20px;
        border-radius: 25px;
        background: linear-gradient(90deg, #007bff, #00a1ff);
        color: white;
        font-weight: 600;
        border: none;
        transition: all 0.3s ease;
        width: 100%;
    }

    .btn-save:hover {
        background: linear-gradient(90deg, #0056b3, #0087d1);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
    }

    .permission-item {
        display: flex;
        align-items: center;
        padding: 10px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 10px;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .flashes {
        list-style: none;
        padding: 0;
        margin-bottom: 20px;
    }

    .flashes li {
        background: #ffdddd;
        border-left: 4px solid #ee2b47;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        color: #d81f3a;
    }

    @media (max-width: 768px) {
        .role-container {
            margin: 20px 15px;
        }

        .role-header {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }

        .role-table th,
        .role-table td {
            font-size: 0.85rem;
            padding: 10px;
        }

        .staff-table th,
        .staff-table td {
            font-size: 0.8rem;
            padding: 8px;
        }

        .modal-content {
            width: 95%;
        }
    }
</style>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">

<div class="role-container">
    <h1><i class="fas fa-users-cog"></i> Danh S√°ch Nh√≥m Quy·ªÅn</h1>
    {% if flashes %}
    <ul class="flashes">
        {% for message in flashes %}
        <li>{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    <div class="role-table">
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>M√£ Nh√≥m</th>
                <th>T√™n Nh√≥m Quy·ªÅn</th>
                <th>S·ªë Nh√¢n Vi√™n</th>
                <th>Thao T√°c</th>
            </tr>
        </thead>
        <tbody>
            {% for role in role_groups %}
            <tr>
                <td>
                    {% if role.id != 3 %}
                    <button onclick="toggleRow('{{ role.id }}')" id="toggle-btn-{{ role.id }}" class="toggle-btn">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    {% endif %}
                </td>
                <td>{{ role.id }}</td>
                <td class="font-semibold">{{ role.role_name }}</td>
                <td id="staff-count-{{ role.id }}">-</td>
                <td>
                    {% if role.id != 3 %}
                    <button onclick="openAddModal('{{ role.id }}')" class="btn-action btn-add-staff">Th√™m</button>
                    {% endif %}
                    <button onclick="openPermissionModal('{{ role.id }}')" class="btn-action btn-manage-perms">Qu·∫£n L√Ω Quy·ªÅn</button>
                </td>
            </tr>
            {% if role.id != 3 %}
            <tr id="row{{ role.id }}" style="display: none;">
                <td colspan="5">
                    <div id="staff-list-{{ role.id }}" class="text-gray-500 italic"></div>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal Th√™m Nh√¢n Vi√™n -->
<div id="addStaffModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-user-plus"></i> Th√™m Nh√¢n Vi√™n</h3>
            <button onclick="closeModal('addStaffModal')" class="btn-close">√ó</button>
        </div>
        <div class="modal-body">
            <ul id="staffList" class="mt-4"></ul>
        </div>
        <div class="modal-footer">
            <button onclick="confirmAddStaff()" class="btn-save">Th√™m</button>
        </div>
    </div>
</div>

<!-- Modal Qu·∫£n L√Ω Quy·ªÅn -->
<div id="permissionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-cogs"></i> Qu·∫£n L√Ω Ch·ª©c NƒÉng Nh√≥m</h3>
            <button onclick="closeModal('permissionModal')" class="btn-close">√ó</button>
        </div>
        <div class="modal-body">
            <h4 class="font-semibold mb-3">üîπ Ch·ª©c NƒÉng Hi·ªán T·∫°i:</h4>
            <div class="staff-table">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>T√™n Ch·ª©c NƒÉng</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody id="roleFunctionsList">
                        <tr>
                            <td colspan="3" class="text-gray-500 italic">ƒêang t·∫£i...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <h4 class="font-semibold mt-4 mb-3">‚ûï Ch·ªçn Quy·ªÅn B·ªï Sung:</h4>
            <div id="permissionList" class="p-2 bg-gray-100 rounded-lg" style="max-height: 200px; overflow-y: auto;">
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="savePermissions()" class="btn-save">L∆∞u Thay ƒê·ªïi</button>
        </div>
    </div>
</div>

<script>
    let selectedRoleId = null;

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('addStaffModal').style.display = 'none';
        document.getElementById('permissionModal').style.display = 'none';
    });

    function toggleRow(roleId) {
        let row = document.getElementById('row' + roleId);
        let button = document.getElementById('toggle-btn-' + roleId);
        let staffList = document.getElementById('staff-list-' + roleId);
        let staffCount = document.getElementById('staff-count-' + roleId);

        const isHidden = row.style.display === 'none' || row.style.display === '';
        row.style.display = isHidden ? 'table-row' : 'none';
        button.classList.toggle('active', isHidden);

        if (isHidden && !staffList.dataset.loaded) {
            staffList.innerHTML = 'ƒêang t·∫£i...';
            fetch(`/role_groups/staffsByRoleGroup/${roleId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('L·ªói khi t·∫£i danh s√°ch nh√¢n vi√™n');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("D·ªØ li·ªáu nh√¢n vi√™n:", data);
                    if (Array.isArray(data) && data.length > 0) {
                        staffList.innerHTML = `
                            <table class='staff-table'>
                                <thead>
                                    <tr>
                                        <th>T√™n Nh√¢n Vi√™n</th>
                                        <th>Email</th>
                                        <th>X√≥a</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.map(staff => `
                                        <tr>
                                            <td>${staff.full_name || 'N/A'}</td>
                                            <td>${staff.email || 'N/A'} </td>
                                            <td><button onclick="removeStaff(${staff.account_id.id}, ${roleId})" class='btn-remove'>‚ùå</button></td>
                                        </tr>
                                    `).join('')
                            }
                                </tbody >
                            </table > `;
                        staffCount.innerText = data.length;
                    } else {
                        staffList.innerHTML = '<p class="text-gray-500 italic">Ch∆∞a c√≥ nh√¢n vi√™n trong nh√≥m n√†y.</p>';
                        staffCount.innerText = '0';
                    }
                    staffList.dataset.loaded = 'true';
                })
                .catch(error => {
                    console.error('L·ªói:', error);
                    staffList.innerHTML = '<p class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu.</p>';
                    staffCount.innerText = '-';
                });
        }
    }

    function removeStaff(accountId, roleGroupId) {
        fetch(`/role_groups/remove_staff/role_group=${roleGroupId}&account_id=${accountId}`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success || !data.error) {
                    // ‚úÖ C·∫≠p nh·∫≠t l·∫°i b·∫£ng m√† kh√¥ng toggle m·∫•t
                    const staffListContainer = document.getElementById('staff-list-' + roleGroupId);
                    const staffCount = document.getElementById('staff-count-' + roleGroupId);
                    staffListContainer.innerHTML = '<p class="text-gray-500 italic">ƒêang t·∫£i l·∫°i...</p>';

                    fetch(`/role_groups/staffsByRoleGroup/${roleGroupId}`)
                        .then(res => res.json())
                        .then(staffs => {
                            if (Array.isArray(staffs) && staffs.length > 0) {
                                staffListContainer.innerHTML = `
                            <table class='staff-table'>
                                <thead>
                                    <tr>
                                        <th>T√™n Nh√¢n Vi√™n</th>
                                        <th>Email</th>
                                        <th>X√≥a</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${staffs.map(staff => `
                                        <tr>
                                            <td>${staff.full_name || 'N/A'}</td>
                                            <td>${staff.email || 'N/A'}</td>
                                            <td><button onclick="removeStaff(${staff.account_id.id}, ${roleGroupId})" class='btn-remove'>‚ùå</button></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                                staffCount.innerText = staffs.length;
                            } else {
                                staffListContainer.innerHTML = '<p class="text-gray-500 italic">Ch∆∞a c√≥ nh√¢n vi√™n trong nh√≥m n√†y.</p>';
                                staffCount.innerText = '0';
                            }

                            // ‚úÖ Alert sau khi render l·∫°i
                            alert('ƒê√£ x√≥a nh√¢n vi√™n kh·ªèi nh√≥m quy·ªÅn.');
                        })
                        .catch(err => {
                            console.error(err);
                            alert('L·ªói khi t·∫£i l·∫°i danh s√°ch sau khi x√≥a.');
                        });

                } else {
                    alert(data.message || 'X√≥a kh√¥ng th√†nh c√¥ng.');
                }
            })
            .catch(error => {
                console.error('L·ªói:', error);
                alert('L·ªói khi x√≥a nh√¢n vi√™n.');
            });
    }

    function openAddModal(roleId) {
        selectedRoleId = roleId;
        document.getElementById('addStaffModal').style.display = 'flex';
        let staffList = document.getElementById('staffList');
        staffList.innerHTML = 'ƒêang t·∫£i...';
        fetch('/role_groups/get_staffs_not_in_role_group/' + selectedRoleId)
            .then(response => response.json())
            .then(data => {
                if (data && Array.isArray(data) && data.length > 0) {
                    staffList.innerHTML = data.map(staff =>
                        `<li><label><input type='checkbox' value='${staff.account_id.id}'> ${staff.full_name} (${staff.email})</label></li>`
                    ).join('');

                } else {
                    staffList.innerHTML = `< p class="text-gray-500 italic" > Kh√¥ng c√≤n nh√¢n vi√™n n√†o ƒë·ªÉ th√™m.</p > `;
                }
            })
            .catch(error => {
                console.error('L·ªói:', error);
                staffList.innerHTML = '<p class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu.</p>';
            });
    }

    function confirmAddStaff() {
        let selectedStaffs = Array.from(document.querySelectorAll('#staffList input:checked')).map(cb => cb.value);
        if (selectedStaffs.length === 0) {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt nh√¢n vi√™n ƒë·ªÉ th√™m.');
            return;
        }

        const accountIdsCSV = selectedStaffs.join(',');
        fetch(`/role_groups/AddstaffsByRoleGroup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ account_ids: accountIdsCSV, role_group_id: selectedRoleId })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal('addStaffModal');

                    // üëâ Reset tr·∫°ng th√°i ƒë√£ load c·ªßa b·∫£ng c≈©
                    const staffList = document.getElementById('staff-list-' + selectedRoleId);
                    staffList.dataset.loaded = '';

                    // üëâ ·∫®n v√† m·ªü l·∫°i ƒë·ªÉ trigger reload danh s√°ch m·ªõi
                    document.getElementById('row' + selectedRoleId).style.display = 'none';
                    toggleRow(selectedRoleId);
                } else {
                    alert(data.error || 'L·ªói khi th√™m nh√¢n vi√™n.');
                }
            })
            .catch(error => {
                console.error('L·ªói:', error);
                alert('L·ªói khi th√™m nh√¢n vi√™n.');
            });
    }
    function openPermissionModal(roleId) {
        selectedRoleId = roleId;
        document.getElementById('permissionModal').style.display = 'flex';
        let permissionList = document.getElementById('permissionList');
        let roleFunctionsList = document.getElementById('roleFunctionsList');

        permissionList.innerHTML = '<p class="text-gray-500 italic">ƒêang t·∫£i...</p>';
        roleFunctionsList.innerHTML = '<tr><td colspan="3" class="text-gray-500 italic">ƒêang t·∫£i...</td></tr>';

        fetch(`/role_groups/functions/${roleId}`)
            .then(response => response.json())
            .then(data => {
                // Assigned functions
                let assignedFunctions = data.assigned_functions || [];
                roleFunctionsList.innerHTML = assignedFunctions.length > 0
                    ? assignedFunctions.map((perm, index) => `
                    <tr>
                        <td>${perm.id}</td>
                        <td>${perm.function_name || 'N/A'}</td>
                        <td>
                            <button onclick="removeFunction(${perm.id}, ${roleId})" class='btn-remove'>‚ùå</button>
                        </td>
                    </tr>
                `).join('')
                    : `<tr><td colspan="3" class="text-gray-500 italic">Nh√≥m n√†y ch∆∞a c√≥ quy·ªÅn.</td></tr>`;

                // Unassigned functions
                let unassignedFunctions = data.unassigned_functions || [];
                permissionList.innerHTML = unassignedFunctions.length > 0
                    ? unassignedFunctions.map(perm => `
                    <div class="permission-item">
                        <input type="checkbox" value="${perm.id}" class="mr-2">
                        ${perm.function_name}
                    </div>
                `).join('')
                    : '<p class="text-gray-500 italic">Kh√¥ng c√≥ quy·ªÅn n√†o c√≥ th·ªÉ th√™m.</p>';
            })
            .catch(error => {
                console.error('L·ªói:', error);
                permissionList.innerHTML = '<p class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu!</p>';
                roleFunctionsList.innerHTML = '<tr><td colspan="3" class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu!</td></tr>';
            });
    }


    function removeFunction(functionId, roleId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·ª©c nƒÉng n√†y?")) return;
        fetch(`/role_groups/remove_function/${roleId}/${functionId}`, { method: 'DELETE' })
            .then(response => {
                if (!response.ok) throw new Error('L·ªói khi x√≥a ch·ª©c nƒÉng');
                return response.json();
            })
            .then(data => {
                alert(data.message || 'X√≥a ch·ª©c nƒÉng th√†nh c√¥ng');
                openPermissionModal(roleId);
            })
            .catch(error => {
                console.error('L·ªói:', error);
                alert('ƒê√£ x·∫£y ra l·ªói khi x√≥a ch·ª©c nƒÉng.');
            });
    }


    function savePermissions() {
        let selectedPermissions = Array.from(document.querySelectorAll('#permissionList input:checked')).map(cb => parseInt(cb.value));
        if (selectedPermissions.length === 0) {
            alert("B·∫°n ch∆∞a ch·ªçn quy·ªÅn n√†o ƒë·ªÉ th√™m.");
            return;
        }
        // Chuy·ªÉn m·∫£ng selectedPermissions th√†nh chu·ªói JSON tr∆∞·ªõc khi g·ª≠i
        const permissionIdsString = JSON.stringify(selectedPermissions);
        fetch(`/role_groups/add_funcs/${selectedRoleId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ permission_ids: permissionIdsString })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal('permissionModal');
                    openPermissionModal(selectedRoleId);
                    alert("C·∫≠p nh·∫≠t quy·ªÅn th√†nh c√¥ng!");
                } else {
                    alert(data.error || "L·ªói x·∫£y ra khi l∆∞u thay ƒë·ªïi.");
                }
            })
            .catch(error => {
                console.error('L·ªói:', error);
                alert("ƒê√£ x·∫£y ra l·ªói khi l∆∞u thay ƒë·ªïi.");
            });
    }
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
</script>
{% endblock %}