{% extends "admin_base.html" %}
{% block title %}Qu·∫£n l√Ω d·ªãch v·ª•{% endblock %}

{% block content %}
<style>
    .toggle-btn {
        border: none !important;
        background: none !important;
    }

    .toggle-btn i {
        color: #0d6efd;
        /* m√†u primary khi m·ªü */
        transition: color .2s;

    }

    .toggle-btn.closed i {
        color: #6c757d;
        /* m√†u x√°m khi ƒë√≥ng */
    }


    #service-tree-container {
        border: 1px solid #dee2e6;
        border-radius: .25rem;
        padding: .5rem;
        background: #fff;
    }

    /* M·ªói node trong c√¢y */
    .tree-node {
        display: flex;
        align-items: center;
        padding: .25rem .5rem;
        border-bottom: 1px solid #eee;
    }

    /* Xo√° border-bottom cho node cu·ªëi c√πng */
    .tree-node:last-child {
        border-bottom: none;
    }

    /* Toggle button nh·ªè g·ªçn */
    .tree-node .toggle-btn {
        margin-right: .5rem;
        padding: 0;
        width: 1.25rem;
        height: 1.25rem;
    }

    /* T√™n d·ªãch v·ª• */
    .tree-node .service-name {
        flex-grow: 1;
        margin-right: .25rem;
        /* gi·∫£m margin */
    }

    /* H√†nh ƒë·ªông: s√°t t√™n h∆°n */
    .tree-node .actions {
        display: flex;
        gap: .25rem;
        /* kho·∫£ng c√°ch r·∫•t nh·ªè */
        margin-left: 0;
        /* b·ªè margin tr√°i */
    }

    /* N√∫t S·ª≠a/X√≥a g·ªçn h∆°n */
    .tree-node .actions .btn {
        padding: .2rem .3rem;
        /* nh·ªè h∆°n */
        font-size: .85rem;
        /* nh·ªè h∆°n */
    }
</style>

<!-- <div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-sitemap"></i> Qu·∫£n l√Ω d·ªãch v·ª•</h1>




</div> -->

<div class="mb-3">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-sitemap"></i> Qu·∫£n l√Ω d·ªãch v·ª•

        </h1>
        <div>
            <input type="text" id="search-box" class="form-control" placeholder="T√¨m d·ªãch v·ª•...">

            <button onclick="openModal('serviceModal')"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                ‚ûï Th√™m d·ªãch v·ª• m·ªõi
            </button>

        </div>

    </div>

</div>

{% macro render_tree(nodes) %}
<ul class="service-tree list-unstyled">
    {% for node in nodes %}
    <li>
        <div class="tree-node">
            {% if node.children %}
            <button class="toggle-btn" aria-expanded="true">
                <span class="">
                    <i class="fas fa-minus-square"></i>
                </span>
            </button>
            {% else %}
            <span class="toggle-placeholder me-2" style="width:1.25rem;display:inline-block;"></span>
            {% endif %}

            <span class="service-name">{{ node.name }}</span>

            <div class="actions">
                <button class="btn btn-sm btn-outline-primary btn-edit" title="S·ª≠a"
                    onclick="openEditModal({{ node.id }})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" title="X√≥a" onclick="removeService({{ node.id }})">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
        {% if node.children %}
        {{ render_tree(node.children) }}
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% endmacro %}

<div id="service-tree-container">
    {% if service_tree %}
    {{ render_tree(service_tree) }}
    {% else %}
    <p class="text-muted">Ch∆∞a c√≥ d·ªãch v·ª• n√†o.</p>
    {% endif %}
</div>
<!-- Modal Th√™m d·ªãch v·ª• -->
<div id="serviceModal" class="modal"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000;">
    <div class="modal-content"
        style="background:#fff; max-width:500px; margin:5% auto; border-radius:8px; overflow:hidden;">

        <!-- Header -->
        <div class="modal-header" style="padding:1rem; border-bottom:1px solid #eee; position:relative;">
            <h3 class="text-lg font-semibold text-center">‚ûï Th√™m d·ªãch v·ª• m·ªõi</h3>
            <button onclick="closeModal('serviceModal')" class="close"
                style="position:absolute; top:0.75rem; right:1rem; font-size:1.5rem; background:none; border:none; cursor:pointer;">
                &times;
            </button>
        </div>

        <!-- Body -->
        <div class="modal-body" style="padding:1rem;">
            <div class="mb-4">
                <label class="block font-medium mb-1">T√™n d·ªãch v·ª•:</label>
                <input type="text" id="addServiceName" class="w-full border rounded px-3 py-2"
                    placeholder="Nh·∫≠p t√™n d·ªãch v·ª•">
            </div>
            <div class="mb-4">
                <label class="block font-medium mb-1">D·ªãch v·ª• cha:</label>
                <select id="addServiceParent" class="w-full border rounded px-3 py-2">
                    <option value="">‚Äî Kh√¥ng c√≥ ‚Äî</option>
                    {% for s in flat_services %}
                    <option value="{{ s.id }}">{{ s.service_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Coverage checkbox -->
            <div class="mb-4 form-check">
                <input type="checkbox" class="form-check-input" id="addCoverageCheck">
                <label class="form-check-label" for="coverageCheck">Coverage</label>
            </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer" style="padding:1rem; border-top:1px solid #eee;">
            <button onclick="saveAddService()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg w-full">
                üíæ L∆∞u d·ªãch v·ª•
            </button>
        </div>
    </div>
</div>
<!-- Modal S·ª≠a d·ªãch v·ª• -->
<div id="editServiceModal" class="modal"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000;">
    <div class="modal-content" style="background:#fff; max-width:500px; margin:5% auto; border-radius:8px;">
        <div class="modal-header" style="padding:1rem; border-bottom:1px solid #eee; position:relative;">
            <h3 class="text-lg font-semibold">‚úèÔ∏è S·ª≠a d·ªãch v·ª•</h3>
            <button onclick="closeModal('editServiceModal')" class="close"
                style="position:absolute; top:0.75rem; right:1rem; font-size:1.5rem; background:none; border:none;">&times;</button>
        </div>
        <div class="modal-body" style="padding:1rem;">
            <input type="hidden" id="editServiceId">
            <div class="mb-4">
                <label class="block mb-1">T√™n d·ªãch v·ª•:</label>
                <input type="text" id="editServiceName" class="w-full border rounded px-3 py-2">
            </div>
            <div class="mb-4">
                <label class="block mb-1">Ch·ªçn d·ªãch v·ª• cha:</label>
                <div id="editServiceParents" class="max-h-40 overflow-y-auto border rounded p-2">

                    <select id="editServiceParent" class="w-full border rounded px-3 py-2">
                        <option value="">‚Äî Kh√¥ng c√≥ ‚Äî</option>
                        {% for s in flat_services %}
                        <option value="{{ s.id }}">{{ s.service_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="mb-4 form-check">
                <input type="checkbox" class="form-check-input" id="editCoverageCheck">
                <label class="form-check-label" for="editCoverageCheck">Coverage</label>
            </div>
        </div>
        <div class="modal-footer" style="padding:1rem; border-top:1px solid #eee;">
            <button onclick="saveEditService()" class="btn btn-primary w-full">üíæ L∆∞u thay ƒë·ªïi</button>
        </div>
    </div>
</div>

<script>
    // M·ªü modal
    function openModal(id) {
        document.getElementById(id).style.display = 'block';
    }
    // ƒê√≥ng modal
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }
    // M·ªü Add Modal
    function openAddModal() {
        document.getElementById('addServiceName').value = '';
        document.getElementById('addCoverageCheck').checked = false;
        const parentSelect = document.getElementById('newServiceParent');
        if (parentSelect) {
            parentSelect.value = '';
        }
        openModal('addServiceModal');
    }
    // L∆∞u Add
    function saveAddService() {
        const name = document.getElementById('addServiceName').value.trim();
        if (!name) { alert('Nh·∫≠p t√™n d·ªãch v·ª•'); return; }
        // Read parent_id from the <select>
        const parentSelect = document.getElementById('addServiceParent');
        const rawParent = parentSelect.value || null;
        // Convert to integer, or keep null if empty
        const parent_id = rawParent ? parseInt(rawParent, 10) : null;
        const coverage = document.getElementById('addCoverageCheck').checked;
        console.log("sƒësdf", coverage, name, typeof (parent_id))
        fetch('/services/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ service_name: name, parent_id, coverage })
        }).then(r => r.ok ? location.reload() : r.json().then(j => alert(j.error)));
    }
    // Edit
    function openEditModal(id) {
        fetch(`/services/${id}`).then(r => r.json()).then(data => {
            document.getElementById('editServiceId').value = id;
            document.getElementById('editServiceName').value = data.service_name;
            document.getElementById('editCoverageCheck').checked = !!data.coverage;
            document.getElementById('editServiceParent').value = !!data.parent_id;
            const parentSelect = document.getElementById('editServiceParent');

            // 2) G√°n gi√° tr·ªã:
            //    - N·∫øu data.parent_id kh√°c null/undefined, chuy·ªÉn th√†nh string v√† g√°n
            //    - Ng∆∞·ª£c l·∫°i g√°n '' ƒë·ªÉ ch·ªçn option ‚Äú‚Äî Kh√¥ng c√≥ ‚Äî‚Äù
            parentSelect.value = data.parent_id != null
                ? String(data.parent_id)
                : '';
            openModal('editServiceModal');
            console.log(data.service_name)
        });
    }
    function saveEditService() {
        const id = document.getElementById('editServiceId').value;
        const name = document.getElementById('editServiceName').value.trim();
        if (!name) { alert('Nh·∫≠p t√™n d·ªãch v·ª•'); return; }
        // Read parent_id from the <select>
        const parentSelect = document.getElementById('editServiceParent');
        const rawParent = parentSelect.value || null;
        // Convert to integer, or keep null if empty
        const parent_id = rawParent ? parseInt(rawParent, 10) : null;
        const coverage = document.getElementById('editCoverageCheck').checked;
        fetch(`/services/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ service_name: name, parent_id, coverage })
        }).then(r => r.ok ? location.reload() : r.json().then(j => alert(j.error)));
    }
    // M·ªü r·ªông/thu g·ªçn to√†n b·ªô
    function toggleAll(expand) {
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            const ul = btn.closest('li').querySelector('ul');
            if (!ul) return;
            ul.style.display = expand ? '' : 'none';
            btn.innerHTML = expand
                ? '<i class="fas fa-minus-square"></i>'
                : '<i class="fas fa-plus-square"></i>';
        });
    }
    function removeService(serviceId) {
        if (!confirm('X√≥a d·ªãch v·ª• n√†y?')) return;

        fetch(`/services/${serviceId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                // n·∫øu c√≥ CSRF, th√™m v√†o ƒë√¢y
            }
        })
            .then(response => {
                console.log('Delete response:', response);
                if (response.ok) {
                    // Th√†nh c√¥ng, server tr·∫£ 200 + JSON
                    return response.json().then(data => {
                        alert(data.message || 'X√≥a th√†nh c√¥ng');
                        location.reload();
                    });
                } else {
                    // L·ªói (4xx ho·∫∑c 5xx)
                    const contentType = response.headers.get('Content-Type') || '';
                    if (contentType.includes('application/json')) {
                        // Server tr·∫£ JSON l·ªói
                        return response.json().then(err => {
                            alert(err.error || 'X√≥a kh√¥ng th√†nh c√¥ng');
                        });
                    } else {
                        // Server tr·∫£ HTML (trang l·ªói), ƒë·ªçc text ƒë·ªÉ debug
                        return response.text().then(html => {
                            console.error('Server error HTML:', html);
                            alert('C√≥ l·ªói t·ª´ server. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ki·ªÉm tra console.');
                        });
                    }
                }
            })
            .catch(err => {
                console.error('Fetch failed:', err);
                alert('L·ªói k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra m·∫°ng.');
            });
    }
    // H√†m toggle cho t·ª´ng node
    function initToggleButtons() {
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // t√¨m <ul> ngay sau <div class="tree-node">
                const li = btn.closest('li');
                const childUl = li.querySelector('ul');
                if (!childUl) return;

                const isOpen = btn.getAttribute('aria-expanded') === 'true';
                // toggle hi·ªÉn th·ªã
                childUl.style.display = isOpen ? 'none' : '';
                // c·∫≠p nh·∫≠t aria-expanded
                btn.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
                // ƒë·ªïi icon
                btn.innerHTML = isOpen
                    ? '<i class="fas fa-plus-square"></i>'
                    : '<i class="fas fa-minus-square"></i>';
                // toggle class ƒë·ªÉ style m√†u
                btn.classList.toggle('closed', isOpen);
            });
        });
    }
    // T√¨m ki·∫øm nhanh
    document.getElementById('search-box').addEventListener('input', function () {
        const term = this.value.trim().toLowerCase();
        document.querySelectorAll('.service-tree li').forEach(li => {
            const text = li.querySelector('.tree-node span').textContent.toLowerCase();
            li.style.display = text.includes(term) ? '' : 'none';
        });
    });
    function initToggleButtons() {
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // L·∫•y <li> cha v√† <ul> con ngay b√™n d∆∞·ªõi
                const li = btn.closest('li');
                const childUl = li.querySelector('ul');
                if (!childUl) return;  // kh√¥ng c√≥ c√¢y con th√¨ th√¥i

                const expanded = btn.getAttribute('aria-expanded') === 'true';
                console.log("helllo");
                // Toggle hi·ªÉn th·ªã c√¢y con
                childUl.style.display = expanded ? 'none' : '';
                // C·∫≠p nh·∫≠t aria-expanded
                btn.setAttribute('aria-expanded', expanded ? 'false' : 'true');

                // ƒê·ªïi icon b√™n trong <i>
                const icon = btn.querySelector('i.fas');
                if (icon) {
                    icon.classList.toggle('fa-minus-square', expanded === false);
                    icon.classList.toggle('fa-plus-square', expanded === true);
                }

                // Th√™m/b·ªè class .closed ƒë·ªÉ CSS ƒë·ªïi m√†u
                btn.classList.toggle('closed', expanded);
            });
        });
    }

    // document.addEventListener('DOMContentLoaded', () => {
    //     // 1) G·∫Øn toggle cho t·ª´ng n√∫t
    //     initToggleButtons();

    //     // 2) G·∫Øn t√¨m ki·∫øm nhanh
    //     const searchBox = document.getElementById('search-box');
    //     if (searchBox) {
    //         searchBox.addEventListener('input', function () {
    //             const term = this.value.trim().toLowerCase();
    //             document.querySelectorAll('.service-tree li').forEach(li => {
    //                 const name = li.querySelector('.service-name').textContent.toLowerCase();
    //                 li.style.display = name.includes(term) ? '' : 'none';
    //             });
    //         });
    //     }
    // });
    document.addEventListener('DOMContentLoaded', () => {
        // L·∫•y t·∫•t c·∫£ c√°c n√∫t toggle
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // T√¨m th·∫ª <li> cha
                const li = btn.closest('li');
                if (!li) return;

                // T√¨m <ul> con ƒë·∫ßu ti√™n b√™n d∆∞·ªõi li
                const childUl = li.querySelector(':scope > ul');
                if (!childUl) return;

                // Xem hi·ªán ƒëang m·ªü hay ƒë√≥ng
                const isExpanded = btn.getAttribute('aria-expanded') === 'true';
                console.log("helllo");
                // ƒê·ªïi tr·∫°ng th√°i hi·ªÉn th·ªã
                childUl.style.display = isExpanded ? 'none' : '';

                // C·∫≠p nh·∫≠t aria-expanded
                btn.setAttribute('aria-expanded', isExpanded ? 'false' : 'true');

                // ƒê·ªïi icon
                const icon = btn.querySelector('i.fas');
                if (icon) {
                    if (isExpanded) {
                        icon.classList.remove('fa-minus-square');
                        icon.classList.add('fa-plus-square');
                    } else {
                        icon.classList.remove('fa-plus-square');
                        icon.classList.add('fa-minus-square');
                    }
                }

                // Th√™m/b·ªè class closed ƒë·ªÉ style (m√†u x√°m)
                btn.classList.toggle('closed', isExpanded);
            });
        });
    });
</script>
{% endblock %}