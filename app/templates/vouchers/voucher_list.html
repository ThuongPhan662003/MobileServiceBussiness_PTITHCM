{% extends 'admin_base.html' %}

{% block title %}Qu·∫£n L√Ω M√£ Khuy·∫øn M√£i{% endblock %}

{% block content %}
<style>
    :root {
        --primary-color: #d81f3a;
        --secondary-color: #ff6b6b;
        --success-color: #00b14f;
        --blue-color: #3182ce;
        --text-color: #2d3748;
        --bg-color: #f7fafc;
        --white: #ffffff;
        --shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }

    body {
        background-color: var(--bg-color);
        font-family: 'Inter', sans-serif;
        color: var(--text-color);
    }

    .voucher-container {
        max-width: 1280px;
        margin: 40px auto;
        padding: 0 24;
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 24px;
    }

    .voucher-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
    }

    .voucher-header h2 {
        font-size: 1.875rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .voucher-controls {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .search-box {
        padding: 10px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 0.95rem;
        width: 280px;
        transition: all 0.2s ease;
        background-color: var(--white);
    }

    .search-box:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(216, 31, 58, 0.1);
    }

    .btn-add {
        padding: 10px 20px;
        border-radius: 10px;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        color: var(--white);
        font-weight: 600;
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
    }

    .btn-add:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(216, 31, 58, 0.3);
    }

    .voucher-table {
        background: var(--white);
        border-radius: 12px;
        box-shadow: var(--shadow);
        overflow: hidden;
        width: 100%;
        border-collapse: collapse;
    }

    .voucher-table th {
        background: var(--primary-color);
        color: var(--white);
        font-weight: 600;
        padding: 16px;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .voucher-table td {
        padding: 16px;
        vertical-align: middle;
        font-size: 0.95rem;
        border-bottom: 1px solid #edf2f7;
    }

    .voucher-table tr {
        transition: background-color 0.2s ease;
    }

    .voucher-table tr:hover {
        background: #f8fafc;
    }

    .badge {
        padding: 8px 12px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .badge-success {
        background: var(--success-color);
        color: var(--white);
    }

    .badge-danger {
        background: var(--primary-color);
        color: var(--white);
    }

    .btn-action {
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn-edit {
        border: 1px solid var(--blue-color);
        color: var(--blue-color);
    }

    .btn-edit:hover {
        background: var(--blue-color);
        color: var(--white);
        transform: translateY(-1px);
    }

    .btn-delete {
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
    }

    .btn-delete:hover {
        background: var(--primary-color);
        color: var(--white);
        transform: translateY(-1px);
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease;
    }

    .modal.active {
        display: flex;
    }

    .modal-dialog {
        max-width: 560px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-content {
        background: var(--white);
        border-radius: 16px;
        box-shadow: var(--shadow);
        animation: slideIn 0.3s ease;
    }

    .modal-header {
        padding: 20px;
        background: #f7fafc;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 1.25rem;
        color: #718096;
        cursor: pointer;
        transition: color 0.2s ease;
    }

    .btn-close:hover {
        color: var(--text-color);
    }

    .modal-body {
        padding: 24px;
        max-height: 60vh;
        overflow-y: auto;
    }

    .modal-body label {
        display: block;
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--text-color);
    }

    .modal-body input[type="text"],
    .modal-body input[type="date"],
    .modal-body input[type="number"],
    .modal-body select,
    .modal-body textarea {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        background-color: var(--white);
    }

    .modal-body input:focus,
    .modal-body select:focus,
    .modal-body textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(216, 31, 58, 0.1);
    }

    .modal-body textarea {
        resize: vertical;
        min-height: 100px;
        font-family: 'Roboto Mono', monospace;
    }

    .modal-body .form-check {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .modal-body .form-check-label {
        font-size: 0.95rem;
        color: var(--text-color);
    }

    .modal-body .d-flex {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .btn-save,
    .btn-update {
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 600;
        border: none;
        color: var(--white);
        transition: all 0.2s ease;
    }

    .btn-save {
        background: linear-gradient(90deg, var(--success-color), #00d15e);
    }

    .btn-save:hover {
        background: linear-gradient(90deg, #009b43, #00b952);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 177, 79, 0.3);
    }

    .btn-update {
        background: linear-gradient(90deg, var(--blue-color), #00a1ff);
    }

    .btn-update:hover {
        background: linear-gradient(90deg, #0056b3, #0087d1);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(49, 130, 206, 0.3);
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideIn {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @media (max-width: 768px) {
        .voucher-container {
            margin: 24px 16px;
        }

        .voucher-header {
            flex-direction: column;
            gap: 16px;
            text-align: center;
        }

        .voucher-controls {
            width: 100%;
            flex-direction: column;
        }

        .search-box {
            width: 100%;
        }

        .voucher-table th,
        .voucher-table td {
            font-size: 0.9rem;
            padding: 12px;
        }

        .modal-dialog {
            width: 95%;
        }

        .modal-body {
            max-height: 70vh;
        }
    }
</style>

<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap"
    rel="stylesheet">

<div class="voucher-container">
    <div class="voucher-header">
        <h2><i class="fas fa-ticket-alt"></i> Danh S√°ch M√£ Khuy·∫øn M√£i</h2>
        <div class="voucher-controls">
            <input type="text" id="searchBox" class="search-box" placeholder="T√¨m m√£ khuy·∫øn m√£i..." />
            <button class="btn-add" onclick="openModal('addVoucherModal')"><i class="fas fa-plus"></i> Th√™m M√£</button>
        </div>
    </div>

    <table class="voucher-table table table-bordered table-hover" id="voucherTable">
        <thead>
            <tr>
                <th>M√£</th>
                <th>M√¥ T·∫£</th>
                <th>G√≥i √Åp D·ª•ng</th>
                <th>Ng√†y B·∫Øt ƒê·∫ßu</th>
                <th>Ng√†y K·∫øt Th√∫c</th>
                <th>C√≤n L·∫°i</th>
                <th>Ho·∫°t ƒê·ªông</th>
                <th>Thao T√°c</th>
            </tr>
        </thead>
        <tbody id="voucherListBody">
            {% for voucher in vouchers %}
            <tr>
                <td>{{ voucher.code }}</td>
                <td>{{ voucher.description }}</td>
                <td>{{ voucher.packages or "T·∫•t c·∫£" }}</td>
                <td>{{ voucher.start_date }}</td>
                <td>{{ voucher.end_date }}</td>
                <td>{{ voucher.remaining_count}}</td>
                <td class="text-center">
                    {% if voucher.is_active %}
                    <span class="badge badge-success">‚úîÔ∏è</span>
                    {% else %}
                    <span class="badge badge-danger">‚ùå</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    <button class="btn-action btn-edit" onclick="openEditModal({{ voucher.id }})"><i
                            class="fas fa-edit"></i></button>
                    <button class="btn-action btn-delete" onclick="deleteVoucher({{ voucher.id }})"><i
                            class="fas fa-trash"></i></button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal S·ª≠a -->
<div id="editVoucherModal" class="modal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> S·ª≠a M√£ Khuy·∫øn M√£i</h5>
                <button type="button" class="btn-close" onclick="closeModal('editVoucherModal')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editVoucherId">
                <label>M√£ khuy·∫øn m√£i</label>
                <input type="text" id="editCode" class="form-control" placeholder="M√£ khuy·∫øn m√£i" readonly>
                <label>M√¥ t·∫£</label>
                <textarea id="editDescription" class="form-control" rows="4" placeholder="M√¥ t·∫£"></textarea>
                <label>G√≥i √°p d·ª•ng</label>
                <input type="text" id="editPackages" class="form-control" placeholder="G√≥i √°p d·ª•ng">
                <label>Ng√†y b·∫Øt ƒë·∫ßu</label>
                <input type="date" id="editStartDate" class="form-control" required>
                <label>Ng√†y k·∫øt th√∫c</label>
                <input type="date" id="editEndDate" class="form-control" required>
                <label>S·ªë l∆∞·ª£t s·ª≠ d·ª•ng</label>
                <input type="number" id="editUsageLimit" class="form-control" placeholder="S·ªë l∆∞·ª£t s·ª≠ d·ª•ng" readonly>
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="editIsActive">
                    <label class="form-check-label" for="editIsActive">K√≠ch ho·∫°t</label>
                </div>

                <label>üéØ ƒêi·ªÅu ki·ªán √°p d·ª•ng:</label>
                <input type="text" id="promo_subscriber_type" class="form-control"
                    placeholder="Lo·∫°i thu√™ bao (TRASAU/TRATRUOC)">
                <input type="number" id="promo_renewal_times" class="form-control" placeholder="S·ªë l·∫ßn gia h·∫°n">
                <!-- <input type="text" id="promo_created_expr" class="form-control"
                    placeholder="VD: DAY(created_at) BETWEEN 21 AND DAY(LAST_DAY(created_at))"> -->

                <div class="d-flex gap-2 mb-2">
                    <div>
                        <label>Ng√†y b·∫Øt ƒë·∫ßu (trong th√°ng)</label>
                        <input type="number" min="1" max="31" id="promo_day_start" class="form-control"
                            placeholder="VD: 21">
                    </div>
                    <div>
                        <label>Ng√†y k·∫øt th√∫c (trong th√°ng)</label>
                        <select id="promo_day_end" class="form-control">
                            <option value="LAST">Cu·ªëi th√°ng</option>
                            <option value="28">28</option>
                            <option value="29">29</option>
                            <option value="30">30</option>
                            <option value="31">31</option>
                        </select>
                    </div>
                </div>


                <label class="mt-3">üéÅ ∆Øu ƒë√£i:</label>
                <div class="mb-2">
                    <span>Gi·∫£m t·ªïng ti·ªÅn thanh to√°n:</span>
                    <div class="d-flex gap-2">
                        <select id="promo_discount_operator" class="form-control">
                            <option value="">--Ph√©p to√°n--</option>
                            <option value="*">*</option>
                            <option value="-">-</option>
                            <option value="-=">-=</option>
                        </select>
                        <input type="number" id="promo_discount_value" class="form-control" placeholder="VD: 0.5 = 50%">
                    </div>
                </div>

                <div class="mb-2">
                    <span>Th√™m dung l∆∞·ª£ng data:</span>
                    <div class="d-flex gap-2">
                        <select id="promo_data_operator" class="form-control">
                            <option value="">--Ph√©p to√°n--</option>
                            <option value="+">+</option>
                            <option value="+=">+=</option>
                        </select>
                        <input type="number" id="promo_free_data" class="form-control" placeholder="MB t·∫∑ng th√™m">
                    </div>
                </div>

                <label class="mt-3">üßæ JSON Raw:</label>
                <!-- <textarea id="editConAndPro" class="form-control" rows="10" required></textarea> -->
                <textarea id="editConAndPro" class="form-control" rows="10" required readonly></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-update" onclick="updateVoucher()">C·∫≠p Nh·∫≠t</button>
                <!-- <button class="btn-delete" onclick="closeModal('editVoucherModal')">H·ªßy</button> -->
            </div>
        </div>
    </div>
</div>

<!-- Modal Th√™m -->
<div id="addVoucherModal" class="modal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Th√™m M√£ Khuy·∫øn M√£i</h5>
                <button type="button" class="btn-close" onclick="closeModal('addVoucherModal')">√ó</button>
            </div>
            <div class="modal-body">
                <label>M√£ khuy·∫øn m√£i</label>
                <input type="text" id="addCode" class="form-control" placeholder="M√£ khuy·∫øn m√£i" required>
                <label>M√¥ t·∫£</label>
                <input type="text" id="addDescription" class="form-control" placeholder="M√¥ t·∫£">
                <label>G√≥i √°p d·ª•ng</label>
                <input type="text" id="addPackages" class="form-control"
                    placeholder="G√≥i √°p d·ª•ng (c√°ch nhau b·ªüi d·∫•u ,)">
                <label>Ng√†y b·∫Øt ƒë·∫ßu</label>
                <input type="date" id="addStartDate" class="form-control" required>
                <label>Ng√†y k·∫øt th√∫c</label>
                <input type="date" id="addEndDate" class="form-control" required>
                <label>S·ªë l∆∞·ª£t s·ª≠ d·ª•ng</label>
                <input type="number" id="addUsageLimit" class="form-control" placeholder="S·ªë l∆∞·ª£t s·ª≠ d·ª•ng" required>
                <div class="form-check mb-3">
                    <input type="checkbox" id="addIsActive" checked>
                    <label class="form-check-label" for="addIsActive">K√≠ch ho·∫°t</label>
                </div>
                <div class="mb-2">
                    <label>Lo·∫°i thu√™ bao</label>
                    <input type="text" id="promo_add_subscriber_type" class="form-control"
                        placeholder="TRASAU ho·∫∑c TRATRUOC">
                </div>
                <div class="mb-2">
                    <label>S·ªë l·∫ßn gia h·∫°n</label>
                    <input type="number" id="promo_add_renewal_times" class="form-control" placeholder="VD: 2">
                </div>
                <div class="d-flex gap-2 mb-2">
                    <div style="flex: 1">
                        <label>Ng√†y b·∫Øt ƒë·∫ßu (trong th√°ng)</label>
                        <input type="number" id="promo_add_day_start" class="form-control" placeholder="VD: 1" min="1"
                            max="31">
                    </div>
                    <div style="flex: 1">
                        <label>Ng√†y k·∫øt th√∫c (trong th√°ng)</label>
                        <select id="promo_add_day_end" class="form-control">
                            <option value="LAST">Cu·ªëi th√°ng</option>
                            <option value="28">28</option>
                            <option value="29">29</option>
                            <option value="30">30</option>
                            <option value="31">31</option>
                        </select>
                    </div>
                </div>
                <div class="mb-2">
                    <span>Gi·∫£m t·ªïng ti·ªÅn thanh to√°n:</span>
                    <div class="d-flex gap-2">
                        <select id="promo_add_discount_operator" class="form-control">
                            <option value="">--Ph√©p to√°n--</option>
                            <option value="*">*</option>
                            <option value="-">-</option>
                            <option value="-=">-=</option>
                        </select>
                        <input type="number" id="promo_add_discount_value" class="form-control"
                            placeholder="VD: 0.5 = 50%">
                    </div>
                </div>
                <div class="mb-2">
                    <span>Th√™m dung l∆∞·ª£ng data:</span>
                    <div class="d-flex gap-2">
                        <select id="promo_add_data_operator" class="form-control">
                            <option value="">--Ph√©p to√°n--</option>
                            <option value="+">+</option>
                            <option value="+=">+=</option>
                        </select>
                        <input type="number" id="promo_add_free_data" class="form-control" placeholder="MB t·∫∑ng th√™m">
                    </div>
                    <label>ƒêi·ªÅu ki·ªán v√† ∆Øu ƒë√£i (JSON)</label>
                    <textarea id="addConAndPro" class="form-control" rows="6"
                        placeholder='D√°n JSON ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ t·ª± ƒë·ªông sinh'></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn-save" onclick="saveVoucher()">L∆∞u</button>
                    <button class="btn-delete" onclick="closeModal('addVoucherModal')">H·ªßy</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ensure modals are hidden on page load
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('addVoucherModal').style.display = 'none';
            document.getElementById('editVoucherModal').style.display = 'none';
        });
        let originalVoucherData = null;
        function openModal(id) {
            const modal = document.getElementById(id);
            modal.classList.add('active');
            modal.style.display = 'flex';

            if (id === 'addVoucherModal') {
                // document.getElementById('addConAndPro').value = JSON.stringify({
                //     condition: {
                //         plan_id: [13],
                //         subscriber: ["TRASAU"],
                //         created_at: "DAY(created_at) BETWEEN 21 AND DAY(LAST_DAY(created_at))",
                //         renewal_total: 2
                //     },
                //     promotion: {
                //         payments: {
                //             total_amount: {
                //                 operator: "*",
                //                 value: 0.5
                //             }
                //         },
                //         payment_detail: {
                //             free_data: {
                //                 operator: "+",
                //                 value: 5
                //             }
                //         }
                //     }
                // }, null, 2);
                const defaultJson = buildAddConAndProJsonFromForm();
                document.getElementById('addConAndPro').value = JSON.stringify(defaultJson, null, 2);
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            document.getElementById(id).style.display = 'none';
        }

        function saveVoucher() {
            const rawJsonStr = document.getElementById('addConAndPro').value;
            let rawJson;
            try {
                rawJson = JSON.parse(rawJsonStr);
            } catch (e) {
                alert("‚ùå JSON kh√¥ng h·ª£p l·ªá!");
                return;
            }

            // L·∫•y d·ªØ li·ªáu t·ª´ c√°c input
            const code = document.getElementById('addCode').value.trim();
            const description = document.getElementById('addDescription').value.trim();
            const packages = document.getElementById('addPackages').value.trim();
            const startDate = document.getElementById('addStartDate').value;
            const endDate = document.getElementById('addEndDate').value;
            const usageLimit = document.getElementById('addUsageLimit').value.trim();
            const isActive = document.getElementById('addIsActive').checked;

            // Ki·ªÉm tra d·ªØ li·ªáu b·∫Øt bu·ªôc
            if (!code || !packages || !startDate || !endDate || !usageLimit || !rawJsonStr) {
                alert("‚ùóVui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ c√°c tr∆∞·ªùng th√¥ng tin!");
                return;
            }
            // Ki·ªÉm tra ng√†y h·ª£p l·ªá
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (start > end) {
                alert("‚ùå Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n ng√†y k·∫øt th√∫c!");
                return;
            }
            // T·∫°o object d·ªØ li·ªáu
            const data = {
                code: code,
                description: description,
                packages: packages,
                start_date: startDate,
                end_date: endDate,
                usage_limit: parseInt(usageLimit),
                remaining_count: parseInt(usageLimit),
                is_active: isActive,
                conandpromo: rawJson
            };

            // G·ª≠i request
            fetch("/vouchers", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(res => res.ok ? location.reload() : res.json().then(j => alert(j.error)));
        }

        function openEditModal(id) {
            fetch(`/vouchers/${id}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('editVoucherId').value = id;
                    document.getElementById('editCode').value = data.code;
                    document.getElementById('editDescription').value = data.description;
                    document.getElementById('editPackages').value = data.packages;
                    document.getElementById('editStartDate').value = data.start_date;
                    document.getElementById('editEndDate').value = data.end_date;

                    document.getElementById('editIsActive').checked = data.is_active;
                    document.getElementById('editUsageLimit').value = data.usage_limit || 0;
                    let conpro = {};
                    try {
                        conpro = typeof data.conandpromo === 'string'
                            ? JSON.parse(data.conandpromo)
                            : data.conandpromo || {};
                    } catch (e) {
                        console.warn("L·ªói parse conandpromo:", e);
                        conpro = {};
                    }

                    document.getElementById('editConAndPro').value = JSON.stringify(conpro, null, 2);
                    // G√°n ng∆∞·ª£c gi√° tr·ªã v√†o c√°c input ƒëi·ªÅu ki·ªán/∆∞u ƒë√£i
                    const condition = conpro.condition || {};
                    const promo = conpro.promotion || {};
                    const payments = promo.payments || {};
                    const details = promo.payment_detail || {};

                    // Subscriber Type
                    document.getElementById("promo_subscriber_type").value = condition.subscriber?.[0] || null;

                    // Renewal times
                    document.getElementById("promo_renewal_times").value = condition.renewal_total || null;

                    // Parse created_at d·∫°ng: DAY(created_at) BETWEEN <start> AND <end>
                    if (condition.created_at?.includes("DAY(created_at) BETWEEN")) {
                        const regex = /BETWEEN (\d{1,2}) AND (.+)/;
                        const match = condition.created_at.match(regex);
                        if (match) {
                            document.getElementById("promo_day_start").value = match[1];
                            const endVal = match[2].trim();
                            document.getElementById("promo_day_end").value = endVal.includes("LAST") ? "LAST" : endVal;
                        }
                    }

                    // Gi·∫£m gi√°: payments.total_amount
                    if (payments.total_amount) {
                        document.getElementById("promo_discount_operator").value = payments.total_amount.operator || "";
                        document.getElementById("promo_discount_value").value = payments.total_amount.value || "";
                    }

                    // Data: payment_detail.free_data
                    if (details.free_data) {
                        document.getElementById("promo_data_operator").value = details.free_data.operator || "";
                        document.getElementById("promo_free_data").value = details.free_data.value || "";
                    }
                    // L∆∞u d·ªØ li·ªáu g·ªëc ƒë·ªÉ so s√°nh sau
                    originalVoucherData = {
                        code: data.code,
                        description: data.description,
                        packages: data.packages,
                        start_date: data.start_date,
                        end_date: data.end_date,
                        is_active: data.is_active,
                        conandpromo: JSON.stringify(JSON.parse(data.conandpromo))
                    };
                    openModal('editVoucherModal');
                })
                .catch(error => {
                    console.error("L·ªói khi fetch voucher:", error);
                    alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu khuy·∫øn m√£i.");
                });
        }

        function toggleRawConPro() {
            const textarea = document.getElementById("editConAndPro");
            const pre = document.getElementById("formattedConAndPro");
            const isHidden = textarea.style.display === "none";

            if (isHidden) {
                textarea.style.display = "block";
                pre.style.display = "none";
                textarea.focus();
            } else {
                textarea.style.display = "none";
                pre.style.display = "block";
                try {
                    const obj = JSON.parse(textarea.value);
                    pre.textContent = JSON.stringify(obj, null, 2);
                } catch {
                    pre.textContent = "‚ùå JSON kh√¥ng h·ª£p l·ªá!";
                }
            }
        }

        function updateVoucher() {
            const id = document.getElementById('editVoucherId').value;

            let rawJson;
            try {
                rawJson = JSON.parse(document.getElementById('editConAndPro').value);
            } catch (e) {
                alert("‚ùå JSON kh√¥ng h·ª£p l·ªá! Vui l√≤ng ki·ªÉm tra l·∫°i d·ªØ li·ªáu JSON.");
                return;
            }

            const code = document.getElementById('editCode').value.trim();
            const description = document.getElementById('editDescription').value.trim();
            const packages = document.getElementById('editPackages').value.trim();
            const startDate = document.getElementById('editStartDate').value;
            const endDate = document.getElementById('editEndDate').value;
            const isActive = document.getElementById('editIsActive').checked;

            // Ki·ªÉm tra d·ªØ li·ªáu b·∫Øt bu·ªôc
            if (!packages || !startDate || !endDate || !rawJson) {
                alert("‚ùóVui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ c√°c tr∆∞·ªùng th√¥ng tin!");
                return;
            }

            // Ki·ªÉm tra ng√†y h·ª£p l·ªá
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (start > end) {
                alert("‚ùå Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n ng√†y k·∫øt th√∫c!");
                return;
            }

            const currentData = {
                code: code,
                description: description,
                packages: packages,
                start_date: startDate,
                end_date: endDate,
                is_active: isActive,
                conandpromo: JSON.stringify(rawJson)
            };

            // So s√°nh d·ªØ li·ªáu hi·ªán t·∫°i v·ªõi d·ªØ li·ªáu g·ªëc
            if (JSON.stringify(currentData) === JSON.stringify(originalVoucherData)) {
                alert("‚ö†Ô∏è Kh√¥ng c√≥ thay ƒë·ªïi n√†o ƒë·ªÉ c·∫≠p nh·∫≠t.");
                return;
            }

            fetch(`/vouchers/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(currentData)
            })
                .then(res => {
                    if (res.ok) {
                        alert("‚úÖ C·∫≠p nh·∫≠t voucher th√†nh c√¥ng!");
                        location.reload();
                    } else {
                        res.json().then(j => {
                            alert(`‚ùå L·ªói: ${j.message || j.error || "C√≥ l·ªói x·∫£y ra!"}`);
                        });
                    }
                })
                .catch(error => {
                    alert(`‚ùå L·ªói khi g·ª≠i y√™u c·∫ßu: ${error.message}`);
                });
        }

        function deleteVoucher(id) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√£ n√†y kh√¥ng?")) return;
            fetch(`/vouchers/${id}`, {
                method: "DELETE",
            }).then(res => res.ok ? location.reload() : res.json().then(j => alert(j.error)));
        }

        function buildConAndProJsonFromForm() {
            const subscriber = document.getElementById("promo_subscriber_type").value;
            const renewal = parseInt(document.getElementById("promo_renewal_times").value) || 0;
            const created_at = document.getElementById("promo_created_expr").value || "DAY(created_at) BETWEEN 21 AND DAY(LAST_DAY(created_at))";

            const discountOp = document.getElementById("promo_discount_operator").value;
            const discountVal = parseFloat(document.getElementById("promo_discount_value").value);

            const dataOp = document.getElementById("promo_data_operator").value;
            const dataVal = parseFloat(document.getElementById("promo_free_data").value);

            return {
                condition: {
                    plan_id: [13],
                    subscriber: [subscriber],
                    created_at: created_at,
                    renewal_total: renewal
                },
                promotion: {
                    payments: {
                        total_amount: (discountOp && !isNaN(discountVal)) ? {
                            operator: discountOp,
                            value: discountVal
                        } : null
                    },
                    payment_detail: {
                        free_data: (dataOp && !isNaN(dataVal)) ? {
                            operator: dataOp,
                            value: dataVal
                        } : null
                    }
                }
            };
        }

        document.getElementById('searchBox').addEventListener('input', function () {
            const keyword = this.value.toLowerCase();
            document.querySelectorAll('#voucherListBody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(keyword) ? '' : 'none';
            });
        });
        [
            'promo_subscriber_type', 'promo_renewal_times', 'promo_discount_operator',
            'promo_discount_value', 'promo_data_operator', 'promo_free_data',
            'promo_day_start', 'promo_day_end'
        ].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', function () {
                    const json = buildConAndProJsonFromForm();
                    document.getElementById('editConAndPro').value = JSON.stringify(json, null, 2);
                });
            }
        });



        function buildConAndProJsonFromForm() {
            const subscriber = document.getElementById("promo_subscriber_type")?.value;
            const renewal = parseInt(document.getElementById("promo_renewal_times")?.value) || 0;

            const dayStart = document.getElementById("promo_day_start")?.value || "1";
            const dayEndRaw = document.getElementById("promo_day_end")?.value || "LAST";
            const dayEnd = dayEndRaw === "LAST" ? "DAY(LAST_DAY(created_at))" : dayEndRaw;
            const created_at = `DAY(created_at) BETWEEN ${dayStart} AND ${dayEnd}`;

            const discountOp = document.getElementById("promo_discount_operator")?.value;
            const discountVal = parseFloat(document.getElementById("promo_discount_value")?.value);

            const dataOp = document.getElementById("promo_data_operator")?.value;
            const dataVal = parseFloat(document.getElementById("promo_free_data")?.value);

            return {
                condition: {
                    plan_id: [13],
                    subscriber: [subscriber],
                    created_at: created_at,
                    renewal_total: renewal
                },
                promotion: {
                    payments: {
                        total_amount: (discountOp && !isNaN(discountVal)) ? {
                            operator: discountOp,
                            value: discountVal
                        } : null
                    },
                    payment_detail: {
                        free_data: (dataOp && !isNaN(dataVal)) ? {
                            operator: dataOp,
                            value: dataVal
                        } : null
                    }
                }
            };
        }
        function buildAddConAndProJsonFromForm() {
            const subscriber = document.getElementById("promo_add_subscriber_type")?.value;
            const renewal = parseInt(document.getElementById("promo_add_renewal_times")?.value) || 0;

            const dayStart = document.getElementById("promo_add_day_start")?.value || "1";
            const dayEndRaw = document.getElementById("promo_add_day_end")?.value || "LAST";
            const dayEnd = dayEndRaw === "LAST" ? "DAY(LAST_DAY(created_at))" : dayEndRaw;
            const created_at = `DAY(created_at) BETWEEN ${dayStart} AND ${dayEnd}`;

            const discountOp = document.getElementById("promo_add_discount_operator")?.value;
            const discountVal = parseFloat(document.getElementById("promo_add_discount_value")?.value);

            const dataOp = document.getElementById("promo_add_data_operator")?.value;
            const dataVal = parseFloat(document.getElementById("promo_add_free_data")?.value);

            return {
                condition: {
                    plan_id: [13],
                    subscriber: [subscriber],
                    created_at: created_at,
                    renewal_total: renewal
                },
                promotion: {
                    payments: {
                        total_amount: (discountOp && !isNaN(discountVal)) ? {
                            operator: discountOp,
                            value: discountVal
                        } : null
                    },
                    payment_detail: {
                        free_data: (dataOp && !isNaN(dataVal)) ? {
                            operator: dataOp,
                            value: dataVal
                        } : null
                    }
                }
            };
        }
        [
            'promo_add_subscriber_type', 'promo_add_renewal_times',
            'promo_add_day_start', 'promo_add_day_end',
            'promo_add_discount_operator', 'promo_add_discount_value',
            'promo_add_data_operator', 'promo_add_free_data'
        ].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', function () {
                    const json = buildAddConAndProJsonFromForm();
                    document.getElementById('addConAndPro').value = JSON.stringify(json, null, 2);
                });
            }
        });


    </script>
    {% endblock %}